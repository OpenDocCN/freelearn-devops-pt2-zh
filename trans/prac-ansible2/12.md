# 安易贝塔入门

Ansible 非常强大，但它确实需要用户使用 CLI。在某些情况下，这不是最好的选择，例如在您需要从另一个作业触发一个Ansible作业的情况下(在这种情况下，应用编程接口会更好)，或者在这种情况下，应该触发一个作业的人应该只能触发那个特定的作业。在这种情况下，AWX 或安易宝塔是更好的选择。

AWX 和 Ansible Tower 唯一的区别是，AWX 是上游和开源版本，而 Ansible Tower 是红帽和下游产品，官方支持，但有价格，还有交付方式。AWX 可以作为 Docker 容器使用，可以在任何地方运行，而 Ansible Tower 安装在系统上，需要特定版本的 Linux——更具体地说，在撰写本文时是 RHEL 7.4+、RHEL 8.0+和 CentOS 7.4+。在这一章中，我们将使用 AWX 和谈论 AWX，但我们讨论的一切也适用于 Ansible Tower。

本章涵盖以下主题:

*   安装 AWX
*   运行你的第一个剧本从 AWX
*   创建 AWX 项目
*   创建库存
*   创建作业模板
*   运行作业
*   控制进入 AWX
*   创建用户
*   创建团队
*   创建组织
*   在 AWX 分配权限

# 技术要求

虽然安装 AWX 有几种方法，但我们将使用建议的 AWX 安装，它是基于容器的。因此，需要在您的机器上安装以下软件:

*   Ansible 2.4+。
*   码头工人。
*   `docker` Python 模块。
*   `docker-compose` Python 模块。
*   如果你的系统使用**安全增强 Linux** ( **SELinux** )，你还需要`libselinux` Python 模块。

本章假设您已经使用 Ansible 设置了控制主机，详见[第 1 章](01.html)、*ansi ble 入门*，并且您使用的是最新版本—本章中的示例使用 Ansible 2.9 进行了测试。虽然我们将在本章中给出主机名的具体示例，但是您可以自由地用自己的主机名和/或 IP 地址来替换它们，并且将在适当的地方提供如何替换的详细信息。Docker 的安装超出了本书的范围，但是您可以安装 Linux 操作系统附带的版本，也可以安装 Docker CE。必要的 Python 模块可以通过使用`pip`或者通过操作系统包(如果有的话)来安装。

# 安装 AWX

在我们进一步讨论 AWX 之前，最好将它安装在您的机器上，这样您就可以按照说明立即开始使用 AWX。安装 AWX 最方便的方法是遵循以下步骤:

1.  首先，我们需要克隆 AWX Git 存储库，这可以通过运行以下命令来完成:

```
$ git clone https://github.com/ansible/awx.git
```

2.  通过设置密码和机密的合理值来修改`installer/inventory`文件(如`pg_password`、`rabbitmq_password`、`admin_password`和`secret_key`)。

3.  现在我们已经下载了 Ansible AWX 代码和安装程序，我们可以进入安装程序文件夹，通过运行以下代码来执行安装:

```
$ cd awx/installer
$ ansible-playbook -i inventory install.yml
```

`install.yml`行动手册为我们执行了整个安装。它从检查环境中可能的错误配置或缺少的依赖关系开始。如果一切似乎都是正确的，它会继续下载几个 Docker 映像(包括 PostgreSQL、memcached、RabbitMQ、AWX Web 和 AWX 工人)，然后运行它们。

剧本完成后，您可以通过发出`docker ps`命令来检查安装，该命令应该输出如下内容:

```
CONTAINER ID  IMAGE                      COMMAND                 CREATED        STATUS        PORTS     NAMES
7e388622a9a5  ansible/awx_task:5.0.0     "/tini -- /bin/sh ..."  2 minutes ago  Up 2 minutes  8052/tcp awx_task
03946e9f7a74  ansible/awx_web:5.0.0      "/tini -- /bin/sh ..."  2 minutes ago  Up 2 minutes  0.0.0.0:80->8052/tcp awx_web
d1134f5dc89a  ansible/awx_rabbitmq:3.7.4 "docker-entrypoint..."  2 minutes ago  Up 2 minutes  4369/tcp, 5671-5672/tcp, 15671-15672/tcp, 25672/tcp awx_rabbitmq
2184596d2584  postgres:9.6               "docker-entrypoint..."  2 minutes ago  Up 2 minutes  5432/tcp awx_postgres
dd6ebe2f8c8e  memcached:alpine           "docker-entrypoint..."  2 minutes ago  Up 2 minutes  11211/tcp awx_memcached
```

从上面的输出可以看到，我们的系统现在有一个名为`awx_web`的容器，它已经将自己绑定到端口`80`。

现在，您可以通过浏览到`http://<ip address of your AWX host>/`并使用您在本节前面的`inventory`文件中指定的凭据来访问 AWX—请注意，默认管理员用户名是`admin`，除非您在清单中更改它。

现在，您已经学习了安装 AWX 的必要步骤。让我们来看看如何在 AWX 创建一个项目。

# 运行你的第一个剧本从 AWX

就像在 Ansible 一样，在 AWX，目标是运行 Ansible 行动手册，运行的每个行动手册都被称为**作业**。由于 AWX 比 Ansible 给你更多的灵活性和自动化，在你能运行你的第一个工作之前，它需要一点点更多的配置，所以让我们从创建一个 AWX 项目开始深入研究它。

# 创建 AWX 项目

AWX 使用术语**项目**来标识一个Ansible剧本库。AWX 项目支持在所有主要的**源代码管理** ( **供应链管理**)系统中放置行动手册，如 Git、Mercurial 和 SVN，但也支持文件系统上的行动手册或红帽洞察提供的行动手册。要创建项目，请执行以下步骤:

1.  首先，您需要转到左侧菜单栏上的项目，然后单击屏幕左上角绿色背景上带有白色加号的按钮。这将打开一个窗口，如下所示:

![](Images/ef39d1cf-4242-4c53-b421-80eeafc52020.png)

2.  通过填写名称(`Samples Repo`)并为配置管理类型选择 Git，窗口会随着新参数而增长:

![](Images/eb17db9e-b30d-429e-ba6b-328a4191035e.png)

3.  您现在可以添加配置管理网址([https://github.com/ansible/ansible-tower-samples](https://github.com/ansible/ansible-tower-samples))并点击保存按钮，现在应该可以点击了。

正如我们在本节开头提到的，项目是在 AWX 存储和使用行动手册的系统。可以想象，AWX 项目还有很多有趣的附加配置——在我看来，最有趣的是`update revision on launch`。

如果有标记，此选项指示 Ansible 在从该项目运行任何行动手册之前始终更新行动手册的存储库。这确保了它始终执行最新版本的行动手册。这是一个重要的功能，如果您没有检查它，就有可能(或早或晚，这将在您的环境中发生)有人注意到行动手册中有问题并修复它，然后他们运行行动手册，确信他们正在运行最新版本。然后，他们忘记在运行行动手册之前运行同步任务，从而有效地运行了旧版本的行动手册。如果以前的版本相当有问题，这可能会导致重大问题。

使用此选项的缺点是，每次执行一个行动手册时，都会有效地运行两个行动手册，从而增加任务执行的时间。我认为这是一个非常小的缺点，并且不会抵消使用这个选项的好处。

现在，您已经学习了在 Ansible Tower 中创建项目的必要步骤。让我们在下一节中看看如何创建清单。

# 创建库存

与 Ansible Core 一样，为了让 AWX 了解您环境中的机器，我们使用库存。AWX 世界的库存与其在安易宝核心的同类产品没有太大区别。让我们看看如何通过以下步骤在 AWX 创建您的第一个库存:

1.  单击左侧菜单栏中的库存选项。您将被重定向到“清单”窗口，在该窗口中，您可以通过单击屏幕左上角绿色背景上带有白色加号的按钮来创建第一份清单。这与我们创建新项目时不同，因为此按钮不会立即打开创建表单，而是会首先询问您是要创建清单还是智能清单。
2.  选择“清单”选项后，将出现如下框:

![](Images/823edcf9-0f7e-45e9-8ae4-6e205489413c.png)

3.  在此窗口中，您需要设置一个名称，然后保存它。单击“保存”后，“权限”、“组”、“主机”、“源”和“已完成作业”选项卡变得可单击，因此您可以继续配置。

既然空库存无论如何都没有用，我们就要加上`localhost`了。

4.  为此，请选择主机选项卡，然后单击屏幕左上角绿色背景上带有白色加号的按钮。这将打开一个窗口，如下所示:

![](Images/5cfa14a5-404b-4315-b148-410fdeb18d0a.png)

5.  然后，我们需要添加主机名(`localhost`)并通过向 VARIABLES 框中添加以下代码来指示 Ansible 使用本地连接:

```
---
ansible_connection: local
ansible_python_interpreter: '{{ ansible_playbook_python }}'
```

6.  我们现在可以点击保存，保存我们的库存。

我们做出的第一个选择是创建库存还是智能库存。这些选项有什么区别？在 AWX，清单与 Ansible Core 清单非常相似，但具有额外的功能，例如内置的动态清单支持，这意味着您不需要编辑配置文件或安装额外的 Python 模块。要启用此功能，只需转到清单中的“来源”选项卡，选择使用来自真实来源的信息自动填充清单，例如公共云供应商清单(**亚马逊网络服务** ( **AWS** )、Azure 和**谷歌云平台** ( **GCP** )都受支持)、私有云清单(如 VMWare 或 OpenStack)或其他系统，如红帽卫星或自定义脚本。

关于库存来源的一个特别注意事项是，如果选择了“来源于项目”选项，该选项将提供如下形式:

![](Images/06cf1dc8-c1b9-4850-aa0f-5f47766bcfe5.png)

在我看来，这是一个非常有趣的特性，因为它允许用户将他们自己设计的动态清单脚本检查到 Git 存储库中(或者在它自己的存储库中，或者在您也放入行动手册的存储库中)，并且 AWX 从存储库中提取信息。

对于项目，当您向清单中添加源时，您可以选择“启动时更新”选项，该选项的行为方式与项目的“启动时更新”选项完全相同。因此，我强烈建议你也使用这个选项。

智能库存是由 AWX 填充的库存，从其他库存中存在的主机开始，使用用户在创建期间选择的特定智能主机筛选器对其进行筛选。这对于基于过滤器动态创建特定类型主机的库存非常有用，并且省去了手动创建大量不同组的需要，或者更糟的是，不必多次添加同一主机。

现在，您已经了解了在 AWX 创建库存的必要步骤。让我们看看如何创建职务模板。

# 创建作业模板

现在我们的项目中有了行动手册，清单中有了主持人，我们可以开始创建**工作模板**。

AWX 的作业模板是执行作业所需的配置的集合。这与`ansible-playbook`命令行选项非常相似。我们需要创建作业模板的原因是，可以在很少或没有用户输入的情况下启动行动手册的运行，这意味着它们可以委托给可能不知道行动手册如何工作的所有细节的团队，或者甚至可以在没有任何人在场的情况下按计划运行:

1.  首先，您需要点击左侧菜单栏上的模板选项。
2.  现在，您可以通过单击屏幕左上角绿色背景上带有白色加号的按钮来创建新模板。它会询问您是要创建作业模板还是工作流模板，您需要选择作业模板。将出现以下窗口:

![](Images/caa79e71-a3db-431d-8e1a-0d0bb43043d8.png)

可以看到，这个视图中有相当多的字段。继续进行所需的唯一信息是名称(我们将放入`Hello World`)、库存(我们将选择在上一节中创建的`Test Inventory`、在本章中创建库存*部分)、项目(我们将选择在本章上一节中创建的`Samples Repo`项目)和行动手册(我们将选择唯一可用的行动手册`hello_world.yml`)。然后，我们可以点击 SAVE。请注意，因为我们使用到`localhost`的本地连接来运行它，所以我们不需要创建或指定任何凭据。但是，如果您针对一个或多个远程主机运行作业模板，则需要创建一个计算机凭据，并将其与您的作业模板相关联。例如，一个机器凭证是一个 SSH 用户名和密码，或者一个 SSH 用户名和一个私钥——这些都安全地存储在 AWX 的后端数据库中，这意味着您可以再次将剧本相关的任务委托给其他团队，而无需实际给他们密码或 SSH 密钥。*

 *我们必须选择的第一件事是，我们是创建工作模板还是工作流模板。我们选择了作业模板，因为我们希望能够利用该模板创建简单的作业。还可以创建更复杂的作业，这些作业是多个作业模板的组合，在一个作业和下一个作业之间具有流程控制功能。这允许更复杂的情况和场景，其中您可能希望有多个作业(例如创建实例、公司定制、设置 Oracle 数据库、设置 MySQL 数据库等)，但是您也希望有一次单击部署，例如，设置机器、应用所有公司定制并安装 MySQL 数据库。显然，您可能还有另一个部署，它使用除最后一个组件之外的所有相同组件，取而代之的是，它使用 Oracle 数据库来创建 Oracle 数据库机器。这允许您拥有极大的灵活性，并重用大量组件，创建多个几乎相同的行动手册。

有趣的是，作业模板创建窗口中的许多字段都有一个带有启动时提示标题的选项。这是为了能够在创建作业模板期间选择性地设置该值，但也允许运行作业的用户在运行时输入/覆盖该值。当您有一个在每次运行时都会改变的字段(可能是`limit`字段，当与`ansible-playbook`命令一起使用时，该字段的操作方式与`--limit`相同)时，这可能非常有价值，或者也可以用作健全性检查，因为它会在实际运行行动手册之前提示用户该值(并给他们一个修改该值的机会)。但是，它可能会阻止计划的作业运行，因此启用此功能时要小心。

现在，您已经学习了在 AWX 创建职务模板的必要步骤。让我们看看如何创造一份工作。

# 运行作业

顾名思义，作业是作业模板的一个实例。这意味着，要在我们的机器上执行任何操作，我们必须通过以下步骤创建一个作业模板实例，或者更简单地说，一个作业:

1.  现在我们已经设置了作业模板，可以运行作业本身了。为此，我们需要转到页面左侧的模板项目。
2.  找到你想要运行的作业模板(在我们的例子中，这将是`Hello World`一个)，然后我们点击页面右侧对应正确作业模板的小火箭，如下图截图所示:

![](Images/9f27f618-60e1-40fe-8d9f-d5e853c63a1b.png)

当作业运行时，AWX 允许我们在作业的控制面板中跟踪作业的执行情况，如下图所示:

![](Images/d47f9e61-0b2e-42a7-8859-1a0d37fc8044.png)

在屏幕的右侧，作业的输出在执行过程中加载，而左侧为我们提供了有关作业的信息。AWX 和 Ansible Tower 的一大优点是，它们将这个作业执行输出存档在后端数据库中，这意味着在未来的任何时候，您都可以回来查询作业运行，看看发生了什么变化。这对于审计和政策执行等场合来说非常强大和有用。

现在，你已经学会了在 AWX 创造就业机会的必要步骤。让我们看看如何创建用户。

# 控制进入 AWX

在我看来，与 Ansible 相比，AWX 的最大优势之一是 AWX 允许多个用户连接并控制/执行操作。这使得一家公司可以为不同的团队、整个组织甚至多个组织安装一个 AWX 系统。

一个**基于角色的访问控制** ( **RBAC** )系统已经到位，可以管理用户的权限。

AWX 和 Ansible Tower 都可以链接到中心目录，例如**轻量级目录访问协议** ( **LDAP** )和 Azure Active Directory—但是，我们也可以在 AWX 服务器本身的本地创建用户帐户。让我们从本地创建我们的第一个用户帐户开始！

# 创建用户

AWX 的一大优势是能够管理多个用户。这允许我们在 AWX 为每个使用 AWX 系统的人创建一个用户，这样我们就可以确保他们只被授予他们需要的权限。此外，通过使用个人帐户，我们可以确保通过使用审核日志来查看谁执行了什么操作。要创建用户，请执行以下步骤:

1.  转到左侧菜单栏，选择用户选项。
2.  现在，您可以看到用户列表，也可以通过单击屏幕左上角绿色背景上带有白色加号的按钮来创建一个新列表。将出现如下形式:

![](Images/e825aecb-56c2-4eba-be14-0ac7002844b6.png)

通过添加电子邮件地址、用户名和密码(带有确认)，您可以创建新用户。

用户可以有三种类型:

*   **一个普通用户**:这种类型的用户没有任何继承的权限，他们需要被授予特定的权限才能做任何事情。
*   **系统审计员**:这种类型的用户对整个 AWX 安装具有完全只读权限。
*   **系统管理员**:这种类型的用户对整个 AWX 安装有完全权限。

现在，您已经学习了在 AWX 创建用户的必要步骤。让我们简单看一下团队。

# 创建团队

虽然拥有单独的用户帐户是一个非常强大的工具，尤其是对于企业用例，但是必须单独为每个对象(如作业模板或清单)设置权限是非常不方便和麻烦的。每当有人加入一个团队时，他们的用户帐户都必须手动配置为对每个对象都有正确的权限，同样，如果他们离开，也会被删除。

AWX 和 Ansible Tower 拥有与大多数其他 RBAC 系统相同的用户分组概念。唯一稍有不同的是，在用户界面中，他们被称为**团队**，而不是组。但是，您可以简单轻松地创建团队，然后根据需要添加和删除用户。通过用户界面这样做非常简单，您会发现这个过程类似于大多数 RBAC 系统处理用户组的方式，因此我们在此不再赘述。

一旦您建立了您的团队，我建议您将您的权限分配给团队，而不是通过个人用户，因为随着您的组织的发展，这将使您对 AWX 对象权限的管理变得更加容易。说到组织，让我们在下一节看看 AWX 的组织概念。

# 创建组织

有时，您需要多个独立的人员组来管理独立的机器。对于这些场景，组织的使用可以帮助你。一个组织基本上是 AWX 的租户，拥有自己独特的用户帐户、团队、项目、库存和工作模板——这几乎就像拥有一个单独的 AWX 实例！要创建组织，您需要执行以下步骤:

1.  要创建新组织，您需要转到屏幕左侧的“组织”选项。
2.  然后，您可以看到现有的组织，并通过单击屏幕左上角绿色背景上带有白色加号的按钮来创建新的组织。

将出现如下窗口:

![](Images/39582100-fe5a-41dc-9fea-229e85e74c0b.png)

由于唯一的必填字段是“名称”，您只需填写该字段并单击“保存”。

创建组织后，您可以向组织分配任何类型的资源，如项目、模板、库存、用户等。组织是一个很容易理解的概念，但在 AWX，组织在分离角色和责任方面也很强大。最后，在我们完成本节之前，让我们看一下在 AWX 分配权限。

# 在 AWX 分配权限

您会注意到，在我们配置 AWX 的第一个项目、清单和作业模板的过程中，我们导航到的大多数屏幕上都有一个名为“权限”的按钮。当我们使用管理员帐户导航用户界面时，我们可以看到所有选项，但当然，您不会希望授予每个用户管理员权限。

单个用户(或他们所属的团队)可以根据每个对象被授予权限。例如，您可能有一个数据库管理员团队，他们只能使用特定于其角色的作业模板，在数据库服务器清单上查看和执行行动手册。然后，Linux 系统管理员可以访问特定于其角色的清单、项目和作业模板。AWX 隐藏了用户没有权限访问的对象，这意味着数据库管理员永远看不到 Linux 系统管理员对象，反之亦然。

您可以授予用户(或团队)许多不同的权限级别，包括:

*   **管理员**:这是一个**系统管理员**的组织级等价物。
*   **执行**:这类用户只能执行属于组织的模板。
*   **项目管理员**:这种用户可以修改任何属于组织的项目。
*   **库存管理员**:这类用户可以更改任何属于组织的库存。
*   **凭证管理员**:这类用户可以修改任何属于组织的凭证。
*   **工作流管理**:这类用户可以改变任何属于组织的工作流。
*   **通知管理员**:这类用户可以更改属于组织的任何通知。

*   **作业模板管理员**:这类用户可以修改任何属于组织的作业模板。
*   **审核员**:这是相当于一个**系统审核员**的组织级。
*   **成员**:这是一个**普通用户**的组织级等价物。
*   **阅读**:这类用户能够查看属于组织的不可感知的对象。

以上就是我们对 AWX RBAC 的简单观察和对这一强大工具的观察。AWX 是 Ansible 在企业环境中强大功能的一大补充，它确实有助于确保您的用户能够以管理良好、安全且可审核的方式运行 Ansible 行动手册。我们在这一章只触及了表面，但希望这一章能让您了解 AWX 如何帮助您的团队或企业的自动化之旅。

# 摘要

AWX 和 Ansible Tower 是强大的互补工具，它们有力地支持 Ansible 在企业或基于团队的环境中的使用。它们可以帮助保护凭证，否则您将不得不广泛分发这些凭证，审核行动手册的运行历史，并强制实施行动手册的版本控制。这些工具基于网络的用户界面为最终用户的进入创造了较低的障碍，这意味着剧本的运行可以很容易地委托给对 Ansible 知之甚少的团队(只要在出现问题时有合适的升级途径)。简而言之，当在公司环境中实现 Ansible 时，如果不添加 Ansible Tower 或 AWX，就不能认为它的使用是完整的。

在本章中，您学习了如何在您的 Linux 主机上安装 AWX，以及从 AWX 运行您的第一个剧本的必要步骤。您还了解了 AWX 的 RBAC，以及该公司如何支持大型多用户环境。

我们现在已经到了这本书的结尾，因为这是最后一章，我想感谢你阅读了整本书，我希望它教会了你最初希望了解的关于 Ansible 的东西。

# 问题

1.  你可以在易卜塔中创建哪些对象？

用户

工作

c)职务模板

模块

项目

2.  对还是错——AWX 是红帽 Ansible Tower 的上游和开源版本。

真的吗

假的*