# Ansible 简介

在我们的第一章中，我们将着眼于像 Ansible 这样的工具出现之前的技术世界，以便理解为什么需要 Ansible。

在我们开始谈论 Ansible 之前，让我们快速讨论一下旧世界。从 90 年代末开始，我就一直在使用服务器，主要是服务于网页的服务器，现在的情况已经面目全非了。为了让您了解我以前是如何操作早期服务器的，下面是我最初几年运行服务器的快速概述。

像当时的大多数人一样，我从一个共享托管账户开始，当我当时运行的网站超过共享托管时，我几乎无法控制服务器端的任何事情。我搬到了一个专用的服务器上，我以为我可以在这里施展我未来的系统管理员才能，但我错了。

我得到的服务器是一个钴 RaQ 3，一个 1U 服务器设备，在我看来，这是超前的。然而，我没有机器的根级访问权限，我需要做的所有事情都必须使用基于网络的控制面板。最终，我获得了一定程度的访问权限，可以使用 SSH 或 Telnet 访问服务器(我知道，那是早期)，我开始通过在 web 控制面板中进行更改并查看服务器上配置文件的更改来自学如何成为系统管理员。

过了一会儿，我换了服务器，这次我选择放弃任何基于网络的控制面板，只使用我在 Cobalt RaQ 中学到的知识，通过使用我做的笔记页面来配置我的第一台合适的 **Linux、Apache、MySQL、PHP** ( **LAMP** )服务器。我已经创建了我自己的一行程序来安装和配置我需要的软件，以及许多潦草的东西来帮助我调查问题并保持灯亮着。

在我为另一个项目获得第二台服务器后，我意识到这可能是一个打印笔记的好时机，这样我就可以在需要部署服务器时复制并粘贴它们，我很高兴我这样做了，因为这是在我的第一台服务器失败后不久——我的主机道歉了，并用一台规格更高但完全新的机器替换了它，该机器具有更新的操作系统。

因此，我抓起包含我所做笔记的微软 Word 文件，然后复制并粘贴每条指令，根据我需要安装的内容以及升级后的操作系统进行调整。几个小时后，我启动并运行了我的服务器，恢复了我的数据。

我学到的一个重要教训，除了没有太多备份这种事，就是不要用微软的 Word 来存储这些类型的笔记；该命令不关心您的笔记是否都用标题和快递字体为您需要粘贴的位进行了很好的格式化。它真正关心的是使用正确的语法，Word 已经成功地自动更正了语法，并设置了打印格式。

所以，我在服务器上复制了一份历史文件，并用明文转录了我的笔记。这些笔记为接下来的几年奠定了基础，因为我开始编写它们的一部分，大部分是不需要任何用户输入的部分。

这些零碎的命令、俏皮话和脚本都是通过红帽 Linux 6 改编的——注意没有 *Enterprise* 这个词——一直到 CentOS 3 和 4。

当我改变角色，停止使用来自网络主机的服务，并开始为其中一个服务工作时，事情变得复杂了。突然之间，我开始为那些可能与我自己的项目有不同需求的客户构建服务器——没有一台服务器是相同的。

从这里，我开始使用 Kickstart 脚本、PXE 引导服务器、映像服务器上的黄金大师、虚拟机和 bash 脚本，这些脚本开始提示正在构建的系统的信息。我也从只需要担心维护自己的服务器，转变为必须登录数百个不同的物理和虚拟服务器，从属于我工作的公司的服务器到客户的机器。

在接下来的几年里，我的单个文本文件很快就变成了笔记、脚本、预编译二进制文件和电子表格信息的复杂集合，老实说，这些信息对我来说只有意义。

虽然我已经开始使用 bash 脚本和串起的命令来自动化我日常工作的相当多的部分，但我发现我的日子仍然充满了手动运行所有这些任务，以及在服务台处理客户报告的问题和查询。

我的故事可能是许多人的典型，而使用的操作系统可能会被认为是相当古老的。现在，使用图形用户界面并转到命令行，同时保留常用命令的暂存区，这是我听到的一个相当常见的切入点。

我们将涵盖以下主题:

*   谁在 Ansible 后面
*   Ansible 和其他工具的区别
*   Ansible 解决的问题

# Ansible 的故事

让我们快速了解一下谁写了 Ansible，以及 Ansible 是什么意思。

# 剧场

在讨论 Ansible 是如何开始的之前，我们应该先快速讨论一下这个名字的由来。“可译”一词是由科幻小说家厄休拉·K·勒·古恩执笔的；它最早出现在她 1966 年出版的小说《罗汉南的世界》中。在这个故事的背景下，一个“T2”可翻译的“T3”是一个虚构的设备，它能够比光更快地发送和接收信息。

In 1974, Ursula K. Le Guin's novel *The Dispossessed: An Ambiguous Utopia*, was published; this book features the development of the Ansible technology by exploring the (fictional) details of the mathematical theory that would make such a device possible.

此后，该术语被该流派的其他几位著名作者用来描述能够在星际间传递信息的通信设备。

# 软件

该软件 Ansible 最初是由迈克尔·德哈恩开发的，他也是《鞋匠》*的作者，该软件是在德哈恩为红帽工作时开发的。*

*Cobbler is a Linux installation server that allows you to quickly deploy servers within your network; it can help with DNS, DHCP, package updates and distribution, virtual machine deployment, power management of physical hosts, and also the handoff of a newly deployed server, be it physical or virtual, to a configuration management system.

DeHaan 离开了红帽，在 Puppet 等公司工作，这是一个很好的选择，因为许多 pipper 的用户使用它来移交给 Puppet 服务器，以便在服务器配置完成后管理它们。

离开 Puppet 几年后，德汉第一次公开承诺实施 Ansible 项目；这是 2012 年 2 月 23 日。最初的自述文件给出了相当简单的描述，为 Ansible 最终成为什么奠定了基础:

"Ansible is an extra-simple Python API for doing 'remote things' over SSH. As Func, which I co-wrote, aspired to avoid using SSH and have it's own daemon infrastructure, Ansible aspires to be quite different and more minimal, but still able to grow more modularly over time."

自第一次提交以来，在撰写本文时，已经有 3，000 个贡献者在 38 个分支和 195 个发布中提交了超过 35，000 次。

2013 年，该项目发展壮大，Ansible，Inc .成立，为 Ansible 用户提供商业支持，这些用户依靠该项目管理他们的讲师和服务器，无论他们是物理的、虚拟的还是托管在公共云上。

从获得 600 万美元系列 A 资金的 Ansible，Inc .的形成中，出现了商业 Ansible Tower，它充当了基于网络的前端，最终用户可以使用基于角色的访问 Ansible 服务。

然后，在 2015 年 10 月，红帽宣布他们将以 1.5 亿美元收购 Ansible。公告中援引收购时担任红帽公司管理副总裁的乔·菲茨杰拉德的话说:

"Ansible is a clear leader in IT automation and DevOps, and helps Red Hat take a significant step forward in our goal of creating frictionless IT."

在这本书的过程中，你会发现原始自述文件中的陈述和红帽在获得 Ansible 时的陈述听起来都是真实的。

在我们考虑卷起袖子安装 Ansible(我们将在下一章中进行)之前，我们应该先了解一下围绕它的一些核心概念。

# Ansible 与其他工具相比

如果您将第一次提交中的设计原则与当前版本进行比较，您会注意到，虽然有一些增加和调整，但核心原则基本保持不变:

*   **无代理**:一切都应该由 SSH 守护程序管理，在 Windows 机器的情况下是 WinRM 协议，或者 API 调用——不应该依赖于定制代理或者需要在目标主机上打开或交互的额外端口
*   **最小**:您应该能够管理新的远程机器，而不必安装任何新软件，因为每个 Linux 主机通常至少安装 SSH 和 Python 作为最小安装的一部分
*   **描述性**:你应该能够用机器和人类都可以阅读的语言来描述你的基础设施、堆栈或任务
*   **简单**:设置流程和学习曲线要简单，感觉直观
*   **易用**:应该是有史以来最容易使用的 It 自动化系统

其中一些原则使 Ansible 与其他工具大不相同。让我们来看看 Ansible 和其他工具(如 Puppet 和 Chef)之间最基本的区别。

# 陈述句与祈使句

当我第一次开始使用 Ansible 时，我已经实现了 Puppet 来帮助管理我所管理的机器上的堆栈。随着配置变得越来越复杂，Puppet 代码变得极其复杂。这是我开始寻找替代方案的时候，这些方案解决了我面临的一些问题。

Puppet 使用自定义声明性语言来描述配置。然后，Puppet 将此配置打包为清单，运行在每台服务器上的代理将应用该清单。

声明性语言的使用意味着 Puppet、Chef 和其他配置工具(如 CFEngine)都使用最终一致性原则进行操作，这意味着最终，在代理运行几次后，您想要的配置就会到位。

另一方面，Ansible 是一种命令式语言，意思是，不仅仅是定义你想要的结果的结束状态，让工具决定它应该如何到达那里，你还要定义任务执行的顺序，以便达到你定义的状态。

我倾向于使用的例子如下。我们有一个配置，其中以下状态需要应用于服务器:

1.  创建一个名为`Team`的群组
2.  创建一个用户`Alice`并将她添加到群组`Team`
3.  创建一个用户`Bob`并将其添加到组`Team`
4.  给予用户`Alice`升级权限

这看似简单；但是，当您使用声明性语言执行这些任务时，例如，您可能会发现发生了以下情况:

*   **运行 1** :任务按以下顺序执行:2、1、3、4。这意味着在第一次运行时，由于名为`Team`的组不存在，添加用户`Alice`失败，这意味着`Alice`从未被授予升级权限。但是，添加了组`Team`，并且添加了名为`Bob`的用户。
*   **运行 2** :同样，任务按照以下顺序执行:2、1、3 和 4。因为组`Team`是在运行 1 期间创建的，所以用户`Alice`现在已经创建，并且她也被赋予了升级权限。由于群组`Team`和用户`Bob`已经存在，它们保持原样。
*   **运行 3** :任务的执行顺序与运行 1 和运行 2 相同；但是，由于已经达到了所需的配置，因此没有进行任何更改。

例如，如果`Bob`真的惹恼了`Alice`并且她使用她升级的特权将用户`Bob`从主机中移除，则每次后续运行将继续，直到配置或主机本身发生变化。当代理下次运行时，`Bob`将被重新创建，因为这仍然是我们想要的配置，不管`Alice`认为`Bob`应该有什么访问权限。

如果我们使用命令式语言运行相同的任务，那么应该会发生以下情况:

*   **运行 1** :任务按照我们定义的顺序执行，也就是说先创建组，再创建两个用户，最后应用`Alice`的升级权限
*   **运行 2** :再次按顺序执行任务，并进行检查以确保我们期望的配置到位

正如您所看到的，这两种方式都可以达到我们的最终配置，并且它们也强制实现我们想要的状态。通过使用声明性语言的工具，可以声明依赖关系，这意味着我们可以简单地设计出运行任务时遇到的问题。

然而，这个例子只有四个步骤；当您有几百个步骤在公共云平台中启动服务器，然后安装需要几个先决条件的软件时，会发生什么？

这是我开始使用 Ansible 之前发现自己所处的位置。Puppet 非常擅长执行我想要的最终配置；然而，当到达那里时，我发现自己不得不担心在我的清单中建立大量的逻辑来达到我想要的状态。

同样令人恼火的是，每次成功的跑步大约需要 40 分钟才能完成。但是当我遇到依赖问题时，我必须从每一次失败和改变开始，以确保我实际上解决了问题，而不是因为事情开始变得一致——不是你在最后期限想要的。

# 配置与编排

Ansible 和其他工具之间的另一个主要区别是，大多数工具的起源都是为了部署和管理配置状态而设计的系统。

他们通常需要在每台主机上安装一个代理，该代理会发现一些关于它所安装的主机的信息，然后回拨到一个中央服务器，基本上是说*嗨，我是服务器 XYZ，我可以有我的配置吗？*然后，服务器决定服务器的配置是什么样的，并将其发送给代理，代理再应用它。通常，这种交换每 15 到 30 分钟进行一次，如果您需要在服务器上实施配置，这非常好。

然而，Ansible 的设计运行方式允许它充当编排工具；例如，您可以运行它来启动您的 VMware 环境中的服务器，一旦服务器启动，它就可以连接到您新启动的机器并安装 LAMP 堆栈。然后，它就再也不用连接到那个主机了，这意味着我们只剩下服务器、LAMP 堆栈，除了文件中的一些注释说 Ansible 添加了一些配置行之外，什么都没有了——但这应该是 Ansible 被用来配置主机的唯一标志。

# 基础设施即代码

在我们完成本章并继续安装 Ansible 之前，让我们先快速讨论一下作为代码的基础设施，首先看一些实际代码。以下 bash 脚本使用`yum`包管理器安装了几个 rpm:

```
#!/bin/sh
LIST_OF_APPS="dstat lsof mailx rsync tree vim-enhanced git whois iptables-services"
yum install -y $LIST_OF_APPS
```

下面是一个 Puppet 类，它执行与前面的 bash 脚本相同的任务:

```
class common::apps {
  package{
    [
      'dstat',
      'lsof',
      'mailx',
      'rsync',
      'tree',
      'vim-enhanced',
      'git',
      'whois',
      'iptables-services',
    ]:
    ensure => installed,
  }
}
```

接下来，我们使用 SaltStack 执行相同的任务:

```
common.packages:
  pkg.installed:
    - pkgs:
      - dstat
      - lsof
      - mailx
      - rsync
      - tree
      - vim-enhanced
      - git
      - whois
      - iptables-services
```

最后，我们再次执行相同的任务，这次使用的是 Ansible:

```
- name: install packages we need
  yum:
    name: "{{ item }}"
    state: "latest"
  with_items:
    - dstat
    - lsof
    - mailx
    - rsync
    - tree
    - vim-enhanced
    - git
    - whois
    - iptables-services
```

即使不深入任何细节，你也应该能够得到这三个例子中每一个的大致要点。这三个虽然不是严格意义上的基础设施，但都是作为代码的基础设施的有效例子。

这是您管理代码的地方，这些代码以与开发人员管理应用源代码完全相同的方式管理您的基础架构。您使用源代码管理，将它存储在一个集中可用的存储库中，在那里您可以与您的同行协作，您分支并使用拉请求来签入您的更改，并且在可能的情况下，您编写并执行单元测试，以确保在部署到生产环境之前对基础架构的更改是成功且无错误的。这应该尽可能自动化。上述任务中的任何手动干预都应该被视为潜在的失败点，您应该努力实现任务的自动化。

这种基础设施管理方法有几个优点，一个是作为系统管理员，您使用的过程和工具与您的开发人员同事相同，这意味着任何适用于他们的过程也适用于您。这有助于获得更一致的工作体验，也让你接触到以前没有接触或使用过的工具。

其次，更重要的是，它让你可以分享你的工作。在这种方法之前，这种类型的工作在其他人看来是一种只有系统管理员才能完成的黑暗艺术。在公开场合做这项工作可以让你的同事检查和评论你的配置，也可以让你自己对他们的配置做同样的事情。此外，您可以共享您的工作，以便其他人可以将元素合并到自己的项目中。

# 摘要

在我们结束这一章之前，我想结束我自己的个人旅程。正如本章其他地方提到的，我从我的脚本和运行手册集合转移到了 Puppet，这很好，直到我的需求从仅仅管理服务器配置和维护我正在管理的服务器的状态转移。

我需要开始管理公共云中的基础架构。当使用 Puppet 时，这个要求很快让我感到沮丧。当时，缺乏 Puppet 对我的基础设施所需的 API 的覆盖。我确信现在已经好多了，但是我也发现我不得不在我的清单中建立太多关于每个任务执行顺序的逻辑。

大约在这个时候，也就是 2014 年 12 月，我决定看看 Ansible。我知道这一点是因为我写了一篇名为*用 Ansible* 迈出第一步的博文，从那以后，我想我再也没有回头了。从那以后，我向 Ansible 介绍了我的几个同事和客户，并为 Packt 写了以前的书。

在这一章中，我们回顾了我个人使用 Ansible 和 Ansible 所比较的其他一些工具的历史，并讨论了这些工具之间的差异以及 Ansible 的起源。

在下一章中，我们将着眼于安装 Ansible 并针对本地虚拟机运行我们的第一个行动手册。

# 进一步阅读

在本章中，我们提到了木偶和盐堆:

*   Puppet 是一个运行服务器/代理配置的配置管理工具。它有两种风格——开源版本和由公司 Puppet 支持的企业版本。它是一个声明性系统，与 Ruby 紧密相连。关于木偶的更多信息，请参见[https://puppet.com/](https://puppet.com/)。
*   SaltStack 是另一个配置管理工具。它具有极高的可扩展性，虽然它与 Ansible 共享一种设计方法，但它的工作方式与 Puppet 相似，因为它采用了服务器/代理方法。你可以在[https://saltstack.com/](https://saltstack.com/)找到更多关于盐栈的信息。
*   我也提到了我的博客，你可以在[https://media-glass.es/](https://media-glass.es/)找到。*