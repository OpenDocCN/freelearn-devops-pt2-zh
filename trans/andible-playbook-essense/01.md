# 一、构建您的基础架构的蓝图

本书是任何对 Ansible 有概念知识并希望开始编写 Ansible 行动手册以自动化常见基础架构任务、协调应用部署和/或管理跨多个环境的配置的人的入门书。这本书遵循一种渐进的方法，从基础开始，比如学习剧本的解剖结构和编写简单的角色来创建模块化代码。一旦熟悉了基础知识，您将会被介绍一些原语，比如用变量和模板添加动态数据，以及用条件和迭代器控制执行流。接下来是更高级的主题，如节点发现、集群、加密数据和管理环境。最后我们讨论了 Ansible 的配器特性。让我们通过学习行动手册来开始我们的旅程，成为一名可理解的实践者。

在本章中，我们将了解:

*   剧本的剖析
*   有哪些重头戏，如何编写主机清单和搜索模式
*   Ansible模块和包含电池的方法

# 被介绍给 Ansible

**Ansible** 是一款简单、灵活且功能极其强大的工具，可让您自动执行常见的基础架构任务、运行临时命令，以及跨多台机器部署多层应用。尽管您可以使用 Ansible 在多个主机上并行启动命令，但真正的优势在于使用行动手册来管理这些命令。

作为系统工程师，我们通常需要自动化的基础架构包含复杂的多层应用。每个都代表一类服务器，例如负载平衡器、web 服务器、数据库服务器、缓存应用和中间件队列。由于许多应用必须协同工作来提供服务，因此也涉及到拓扑结构。例如，负载均衡器将连接到 web 服务器，web 服务器进而读取/写入数据库，并连接到缓存服务器以获取内存中的对象。大多数时候，当我们启动这样的应用栈时，我们需要以非常特定的顺序配置这些组件。

下面是一个非常常见的三层 web 应用的示例，它运行负载平衡器、web 服务器和数据库后端:

![Getting introduced to Ansible](graphics/B03800_01_01.jpg)

Ansible 允许您将此图表转换为蓝图，该蓝图定义了您的基础架构策略。用于指定此类策略的格式就是行动手册。

以下步骤显示了示例策略及其应用顺序:

1.  在数据库服务器上安装、配置和启动 MySQL 服务。
2.  安装并配置运行带有 **PHP** 绑定的 **Nginx** 的网络服务器。
3.  在网络服务器上部署一个 Wordpress 应用，并将相应的配置添加到 Nginx 中。
4.  部署 Wordpress 后，在所有网络服务器上启动 Nginx 服务。最后，在负载平衡器主机上安装、配置并启动 **haproxy** 服务。用之前创建的所有 web 服务器的主机名更新 haproxy 配置。

以下是一个示例行动手册，它将基础架构蓝图转化为可由 Ansible 执行的策略:

![Getting introduced to Ansible](graphics/B03800_01_02.jpg)

# 戏剧

剧本由一个或多个剧本组成，这些剧本将主机组映射到明确定义的任务。前面的示例包含三个播放，每个播放用于配置多层 web 应用中的一个层。游戏还定义了任务的配置顺序。这使我们能够协调多层部署。例如，仅在启动网络服务器后配置负载平衡器，或执行两阶段部署，其中第一阶段仅添加此配置，第二阶段按所需顺序启动服务。

## YAML——剧本语言

您可能已经注意到了，我们之前编写的剧本更像是一个文本配置，而不是一个代码片段。这是因为 Ansible 的创建者选择使用简单的、人类可读的和熟悉的 YAML 格式来设计基础设施。这增加了 Ansible 的吸引力，因为该工具的用户不需要学习任何特殊的编程语言就可以开始使用。Ansible 代码本质上是自我解释和自我记录的。YAML 速成班应该足以理解基本语法。以下是您需要了解的关于 YAML 的信息，以便开始您的第一部剧本:

*   剧本的第一行应该以“-”(三个连字符)开头，这表示 YAML 文档的开头。
*   YAML 的列表用连字符后跟空格来表示。剧本包含剧本列表；它们用“-”表示。每个游戏都是一个关联数组、一个字典或一个键值对的映射。
*   缩进很重要。列表的所有成员都应该处于相同的缩进级别。
*   每部剧都可以包含由“:”分隔的键值对，以表示主机、变量、角色、任务等。

# 我们的第一部剧本

有了前面解释的基本规则，并假设读者已经快速了解了 YAML 的基本原理，我们现在将开始编写我们的第一个剧本。我们的问题陈述包括以下内容:

1.  在所有主机上创建 devops 用户。该用户应属于`devops`组。
2.  安装“htop”实用程序。 **Htop** 是 top 的改进版本——一个交互式系统过程监视器。
3.  将 Nginx 存储库添加到网络服务器，并将其作为服务启动。

现在，我们将创建我们的第一个行动手册，并将其保存为包含以下代码的`simple_playbook.yml`:

```
---
- hosts: all
  remote_user: vagrant
  sudo: yes
  tasks:

  - group:
      name: devops
      state: present
  - name: create devops user with admin privileges

    user:
      name: devops
      comment: "Devops User"
      uid: 2001
      group: devops
  - name: install htop package
    action: apt name=htop state=present update_cache=yes

- hosts: www
  user: vagrant
  sudo: yes
  tasks:
  - name: add official nginx repository
    apt_repository:
      repo: 'deb http://nginx.org/packages/ubuntu/ lucid nginx'
  - name: install nginx web server and ensure its at the latest version
    apt:
      name: nginx
      state: latest
  - name: start nginx service
    service:
      name: nginx
      state: started
```

我们的剧本包含了两个剧本。每部剧由以下两个重要部分组成:

*   **配置什么**:我们需要配置一个主机或者一组主机来运行对战。另外，我们需要包含有用的连接信息，比如作为哪个用户连接，是否使用`sudo`命令等等。
*   **运行什么**:这包括要运行的任务的规范，包括要修改哪些系统组件以及它们应该处于哪个状态，例如，已安装、已启动或最新。这可以用任务来表示，以后也可以用角色来表示。

现在让我们简单地看一下其中的每一个。

## 创建主机清单

在我们开始用 Ansible 编写行动手册之前，我们需要定义一个需要配置的所有主机的清单，并使其可供 Ansible 使用。稍后，我们将开始针对此清单中的选定主机运行游戏。如果您有一个现有的清单，如 pipper、LDAP、CMDB 软件，或者希望从云提供商(如 ec2)那里获取，可以使用动态清单的概念从 Ansible 中获取。

对于基于文本的本地库存，默认位置为`/etc/ansible/hosts`。但是，对于我们的学习环境，我们将在工作目录中创建一个自定义库存文件`customhosts`，其内容如下所示。您可以自由创建自己的清单文件:

```
#customhosts
#inventory configs for my cluster
[db]
192.168.61.11  ansible_ssh_user=vagrant

[www]
www-01.example.com ansible_ssh_user=ubuntu
www-02 ansible_ssh_user=ubuntu

[lb]
lb0.example.com
```

现在，当我们的剧本将一部剧映射到该组时，该组中的`www` ( `hosts:`)主机将被配置。`all`关键字将匹配清单中的所有主机。

以下是创建清单文件的指南:

*   清单文件遵循 INI 样式的配置，这些配置基本上包括以“`[ ]`”中包含的主机组/类名开始的配置块。这允许在系统类上选择性执行，例如`[namenodes]`。
*   单个主机可以是多个组的一部分。在这种情况下，来自两个组的主机变量将被合并，并应用优先规则。我们将在后面详细讨论变量和优先级。
*   每个组都包含一个主机列表和连接详细信息，例如要连接的 SSH 用户、SSH 端口号(如果非默认)、SSH 凭据/密钥、sudo 凭据等。主机名还可以包含 globs、ranges 等，以便于包含多个相同类型的主机，这些主机遵循一些命名模式。

### 类型

创建主机清单后，最好使用 Ansible 的 ping 模块(例如，`ansible -m ping all`)验证连通性。

## 模式

在前面的剧本中，以下几行决定选择哪些主机来运行特定的剧本:

```
- hosts: all
- hosts: www
```

第一个代码将匹配所有主机，第二个代码将匹配属于`www`组的主机。

模式可以是以下任意一种或它们的组合:

<colgroup><col style="text-align: left"> <col style="text-align: left"></colgroup> 
| 

模式类型

 | 

例子

 |
| --- | --- |
| 组名 | `namenodes` |
| 全部匹配 | `all`或`*` |
| 范围 | `namenode[0:100]` |
| 主机名/主机名列表 | `*.example.com`、`host01.example.com` |
| 不包括的项目:如接受服务项目是由投保以前已患有的疾病或伤害引致的 | `namenodes:!secondaynamenodes` |
| 交集 | `namenodes:&zookeeper` |
| 正则表达式 | `~(nn&#124;zk).*\.example\.org` |

## 任务

播放主机到任务的映射。任务是针对一组符合游戏中指定模式的主机执行的一系列动作。每个游戏通常包含多个任务，这些任务在匹配模式的每台机器上连续运行。例如，看一下下面的代码片段:

```
- group:
 name:devops
 state: present
- name: create devops user with admin privileges
 user:
 name: devops
 comment: "Devops User"
 uid: 2001
 group: devops

```

在前面的例子中，我们有两个任务。第一个是创建一个组，第二个是创建一个用户并将其添加到之前创建的组中。如果注意到，第二个任务中还有一行，以`name:`开始。在编写任务时，最好提供一个人可读的名称来描述这个任务将要实现的目标。否则，将打印操作字符串。

可以通过指定以下内容来声明任务列表中的每个操作:

*   模块的名称
*   可选地，被管理的系统组件的状态
*   可选参数

### 类型

随着 Ansible 的更新版本(0.8 版以上)，编写动作关键字现在是可选的。我们可以直接提供模块的名称来代替。所以，这两条线会有类似的动作，那就是，。安装带有`apt`模块的包装:

```
action: apt name=htop state=present update_cache=yes
apt: name=nginx state=latest

```

Ansible 凭借其包含电池的方法，在其他配置管理工具中脱颖而出。这些电池是“模块”在我们继续之前，了解模块是什么很重要。

### 模块

模块是负责管理特定平台上特定系统组件的封装过程。

考虑以下示例:

*   Debian 的`apt`模块和红帽的`yum`模块帮助管理系统包
*   `user`模块负责在系统上添加、删除或修改用户
*   `service`模块将启动/停止系统服务

模块从用户那里抽象出实际的实现。它们公开了一个声明性语法，该语法接受被管理的系统组件的参数和状态列表。所有这些都可以使用人类可读的 YAML 语法，使用键值对来声明。

就功能而言，对于熟悉 Chef/Puppet 软件的人来说，模块类似于提供者。我们没有编写创建用户的过程，而是使用 Ansible 声明我们的组件应该处于哪个状态，也就是说，要创建哪个用户、它的状态以及它的特征，比如 UID、组、shell 等等。Ansible 通过模块固有地知道实际过程，并在后台执行。

### 类型

`Command`和`Shell`模块是特殊模块。它们既不将键值对作为参数，也不是幂等的。

Ansible 预装了一个模块库，从管理基本系统资源的模块到发送通知、执行云集成等更复杂的模块。如果你想配置一个 ec2 实例，在远程 PostgreSQL 服务器上创建一个数据库，并在 **IRC** 上获得通知，那么 Ansible 有一个模块。这不是很神奇吗？

不用担心找不到外部插件，或者纠结与云提供商集成等等。要查找可用模块的列表，您可以参考位于[http://docs.ansible.com/list_of_all_modules.html](http://docs.ansible.com/list_of_all_modules.html)的 Ansible 文档。

Ansible 也可以扩展。如果你没有找到一个为你做这项工作的模块，写一个很容易，而且不一定要用 Python。可以用您选择的语言为 Ansible 编写模块。这将在[http://docs.ansible.com/developing_modules.html](http://docs.ansible.com/developing_modules.html)详细讨论。

#### 模和幂等性

幂等性是模块的一个重要特征。它可以在您的系统上多次应用，并将返回确定性的结果。它有内置的智能。例如，我们有一个任务，使用`apt`模块来安装 Nginx 并确保它是最新的。如果您多次运行它，会发生以下情况:

*   每次重复运行一次时，`apt`模块会将行动手册中声明的内容与系统上该包的当前状态进行比较。第一次运行时，Ansible 将确定未安装 Nginx，并将继续安装。
*   对于每个后续运行，它将跳过安装部分，除非在上游存储库中有新版本的包可用。

这允许多次执行相同的任务，而不会导致错误状态。除了命令和外壳模块之外，大多数 Ansible 模块都是幂等的。用户必须使这些模块幂等。

## 运行剧本

Ansible 附带了`ansible-playbook`命令来启动行动手册。现在让我们运行我们创建的剧本:

```
$ ansible-playbook simple_playbook.yml -i customhosts

```

以下是运行上述命令时发生的情况:

*   `ansible-playbook`参数是将剧本作为参数(`simple_playbook.yml`)并针对主机运行剧本的命令
*   `simple_playbook`参数包含我们创建的两个玩法:一个用于普通任务，另一个用于安装 Nginx
*   `customhosts`参数是我们的主机清单，它让 Ansible 知道应该调用哪些主机或主机组

启动前面的命令将开始调用 plays，按照我们在 playbook 中描述的顺序编排。以下是前面命令的输出:

![Running the playbook](graphics/B03800_01_03.jpg)

现在我们来分析一下发生了什么:

*   Ansible 读取指定为`ansible-playbook`命令参数的剧本，并开始按顺序执行剧本。
*   我们宣布的第一场比赛，将对阵“`all`”的东道主。`all`关键字是一个特殊的模式，将匹配所有主机(类似于`*`)。因此，第一个游戏中的任务将在我们作为参数传递的清单中的所有主机上执行。
*   在运行任何任务之前，Ansible 将收集关于它将要配置的系统的信息。这些信息是以事实的形式收集的。
*   第一部剧包括`devops`组和用户的创建，以及 htop 包的安装。由于我们的清单中有三个主机，我们看到每个主机打印一行，这表明被管理实体的状态是否有变化。如果状态没有改变，“ok”将被打印。
*   然后，Ansible 进入下一个游戏。这仅在一台主机上执行，正如我们在游戏中指定的“`hosts:www`”，并且我们的库存包含组“`www`”中的一台主机。
*   第二次播放时，添加 Nginx 存储库，安装软件包，启动服务。
*   最后，Ansible 打印“`PLAY RECAP`”部分中运行的剧本摘要。它指示进行了多少修改，是否有任何主机不可访问，或者在任何系统上执行失败。

### 类型

如果主机没有响应或无法运行任务，该怎么办？Ansible 内置了智能功能，可以识别此类问题，并使故障主机停止运行。它不会影响在其他主机上的执行。

# 复习问题

你认为你已经很好地理解这一章了吗？试着回答以下问题来测试你的理解能力:

1.  什么是幂等性？
2.  主机的库存是多少，为什么需要？
3.  行动手册将 __ 映射到 __(填空)
4.  在选择运行游戏的主机列表时，您可以使用哪些类型的模式？
5.  在特定平台上执行操作的实际过程是在哪里定义的？
6.  为什么说 Ansible 自带电池？

# 总结

在本章中，您了解了什么是 Ansible 行动手册，这些行动手册由哪些组件组成，以及如何用它来规划您的基础架构。我们还做了一个关于 YAML 的初级读本——用来创作戏剧的语言。您学习了如何将任务映射到主机，如何创建主机清单，如何使用模式过滤主机，以及如何使用模块在我们的系统上执行操作。然后，我们创建了一个简单的剧本作为概念证明。

在下一章中，我们将开始重构我们的代码，以创建可重用的模块化代码块，并将其称为角色。