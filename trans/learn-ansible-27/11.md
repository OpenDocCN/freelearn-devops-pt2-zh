# AWX 入门

正如我们在前面几章中看到的，Ansible 是一个非常强大的工具。这还不足以让它无处不在。事实上，为了使它变得无处不在，一个工具需要在任何用户级别都易于使用，并且易于以各种方式与现有环境集成。

Ansible Inc 认识到了这一点，并创建了一个名为 Ansible Tower 的工具，它基本上是围绕 Ansible 设置的 Web UI 和 API。Ansible Tower 是一个封闭来源的工具，这也是该公司的主要收入来源。当红帽宣布收购 Ansible 时，其管理层也承诺让 Ansible Tower 开源。几年后，红帽开源了 Ansible Tower，创建了 AWX 项目，现在是 Ansible Tower 的上游，就像 Fedora 是红帽企业 Linux 的上游一样。

在 AWX 之前，其他网络用户界面和应用编程接口集是在开源社区中开发的，比如信号量。AWX 和 Ansible Tower 并不是 Ansible 目前唯一的 Web UI 和 API 集，但它们是更积极开发的解决方案。

在本章中，我们将看到如何设置 AWX 并学习如何使用它。更具体地说，我们将讨论以下内容:

*   建立 AWX
*   了解什么是 AWX 项目以及如何利用它
*   了解什么是 AWX 库存以及它与 Ansible 库存有何不同
*   了解什么是 AWX 工作模板以及如何创建
*   了解什么是 AWX 工作，以及如何执行你的第一份工作

# 技术要求

对于本章，您将需要一台能够运行`ansible`和`docker`并安装了`docker-py`的机器。

# 建立 AWX

与 Ansible 不同，安装 AWX 不仅仅涉及一个命令，但它仍然相当快速和容易。

首先需要安装`ansible`、`docker`、`docker-py`。之后，您需要向所需用户授予运行 Docker 的权限。最后，您需要下载 AWX Git 回购并执行`ansible`行动手册。

# 在 Fedora 中安装附件、Docker 和 Docker-py

让我们从在 Fedora 中安装`docker`、`ansible`和`docker-py`包开始:

```
sudo dnf install ansible docker python-docker-py
```

要启动和启用 Docker 服务，请使用以下命令:

```
sudo systemctl start docker
sudo systemctl enable docker
```

现在我们已经安装了`ansible`、`docker`和`docker-py`，让我们继续授予用户访问 Docker 的权限。

# 授予当前用户在 Fedora 中使用 Docker 的权限

要确保当前用户可以使用 Docker(默认情况下，Fedora 只允许 root 用户使用)，您需要创建一个新的 Docker 组，将当前用户分配给它，然后重新启动 Docker:

```
sudo groupadd docker && sudo gpasswd -a ${USER} docker && sudo systemctl restart docker
```

由于这些组仅在会话开始时分配，因此您需要重新启动会话，但是我们可以通过执行以下操作来强制 Linux 将新组添加到当前会话中:

```
newgrp docker
```

现在我们已经准备好了所有的先决条件，我们可以转移到真正的 AWX 安装。

# 安装 AWX

我们需要做的第一件事是通过执行以下命令来检查`git`存储库:

```
git clone https://github.com/ansible/awx.git
```

一旦 Git 完成了它的任务，我们就可以将目录更改为包含安装程序的目录并运行它:

```
cd awx/installer/
ansible-playbook -i inventory install.yml
```

这将在 Docker 容器和默认配置中安装 AWX。您可以通过更改同一文件夹中的`inventory`文件来调整配置(在运行最后一个命令之前)。

安装过程完成后，您可以打开浏览器，指向`https://localhost`，使用`password`密码的`admin`用户名登录。

登录后，您应该会看到类似以下的页面:

![](assets/0e4ea5a6-e787-40d6-8c22-bc548d9693bf.png)

设置好 AWX 后，您现在将能够执行 Ansible 行动手册，而无需再使用 Ansible 命令行界面。首先，我们需要一个项目，让我们看看如何设置它。

# 创建新的 AWX 项目

AWX 假设你把剧本保存在某个地方，为了能够在 AWX 使用它们，我们需要创建一个项目。

项目基本上是包含可翻译资源(角色和行动手册)的存储库的 AWX 占位符。

当您进入“项目”部分时，在左侧菜单栏中，您将看到如下内容:

![](assets/43d1f1ec-f54e-4d38-b918-bc59a206129f.png)

正如你所看到的，一个演示项目已经就位(安装人员为我们创建了它！)并且它由一个 Git 存储库支持。

在项目名称的左侧，有一个白色圆圈，表示特定项目从未被拖动过。如果出现一个绿色圆圈，这将意味着该项目已经成功完成。一个绿色的脉冲圆圈表示拉动正在进行，而一个红色的停止标志表示出了问题。

在项目的同一行中，有三个按钮:

*   **获取单片机最新版本**:获取当前最新版本的代码
*   **复制**:创建项目的副本
*   **删除**:删除项目

在卡片的右上角，你可以看到一个绿色的加号按钮。这是允许我们添加更多项目的按钮。

通过选择它，一个新的项目卡会出现在“项目”卡的顶部，您可以在此添加新项目。

新项目卡如下所示:

![](assets/d2e61be9-d1c9-4660-9f76-e145fe46429e.png)

它询问关于您要创建的项目的信息:

*   名称:这是项目的显示名称。这是给人类使用的，所以要让它变得人性化！
*   描述:一个额外的展示(仍然是人类的)来理解项目目标。
*   组织:将拥有项目的组织。这将在下一章讨论。现在，让我们保留默认值。
*   配置管理类型:包含代码的配置管理类型。在撰写本文时，支持的选项有:手动、Git、Mercurial、Subversion 和红帽洞察。
*   根据您选择的配置管理类型，会出现更多的字段，例如配置管理网址和配置管理分支。

完成所有必填字段后，您可以保存并查看已添加的新项目。

# 使用 AWX 库存

AWX 的库存相当于 AWX 世界的 Ansible 库存。由于 AWX 是一个图形工具，库存不会存储为文件(在 Ansible 中完成)，而是可以通过 AWX 用户界面进行管理。与 Ansible 库存相比，不受文件约束也给了 AWX 库存更多的灵活性。

AWX 有不同的方式来管理库存。

您可以通过单击左侧菜单上的“库存”项目来实现这一点，您会发现类似的内容:

![](assets/8c479b7f-f596-44a3-afea-49ea888b23d2.png)

至于项目，AWX 提供了一份演示清单。

从左向右看，我们可以找到以下几列:

*   云符号–用于库存同步状态
*   显示状态的常规圆圈(正常或失败)
*   库存名称
*   库存类型
*   拥有库存的组织
*   编辑符号
*   重复符号
*   删除符号

和以前一样，绿色+按钮将允许您创建一个新项目。通过单击它，它会询问您是要创建库存还是智能库存。

我们现在可以选择库存选项，它将允许您添加名称和组织(仅有的两个强制选项)以及其他非强制选项。保存后，您将能够添加主机、组和权限。

如果您不喜欢手动指定主机、组、变量等，有一个源选项卡供您使用。

通过单击“源”选项卡上的+,您将能够从可用类型列表或使用自定义脚本添加源。

撰写本文时可用的来源类型如下:

*   **来源于一个项目**:基本上就是从一个仓库导入一个 Ansible 核心库存文件。
*   **亚马逊 EC2** :它会利用 AWS API 发现你环境中运行的所有 EC2 机器及其特性。
*   **谷歌计算引擎(GCE)** :它会利用谷歌 API 发现你环境中运行的所有 GCE 机器及其特征。

*   **微软 Azure 资源管理器**:它会使用 Azure API 来发现你环境中运行的所有机器及其特性。
*   **VMWare vCenter** :它将使用 VMWare API 来发现您的 vCenter 管理的所有机器及其特征。
*   **红帽卫星 6** :它会利用卫星 API 发现你的卫星管理的所有机器及其特性
*   **红帽 CloudForms** :它会使用 CloudForms API 来发现它所管理的所有机器及其特性。
*   **OpenStack** :它会使用 OpenStack API 来发现你的 OpenStack 环境中运行的所有机器及其特性。
*   **红帽虚拟化**:它将使用 RHEV API 来发现所有机器及其在其上运行的特性。
*   **Ansible Tower** :它将使用另一个 Ansible Tower/AWX 安装 API 来发现由其管理的所有机器及其特性。
*   **自定义脚本**:将使用您在*库存脚本*部分上传的脚本。

我们现在已经看到了如何设置 AWX 库存，这将是下一部分所需要的:设置 AWX 工作模板。

# 了解 AWX 工作模板

在 AWX，我们有工作模板的概念，它基本上是剧本的包装。

要管理职务模板，您必须从左侧菜单转到模板部分，您会发现如下内容:

![](assets/f17c3464-51a2-4a32-82ea-51888f89b563.png)

查看包含职务模板的表格，我们会发现以下内容:

*   作业模板名称
*   模板类型(AWX 还支持工作流模板，这是职务模板组的模板)
*   火箭按钮
*   复制按钮
*   删除按钮

通过点击火箭按钮，我们可以执行它。这样做会自动将您带入一个不同的视图，我们将在下一节中发现这一点。

# 利用 AWX 的工作

AWX 作业是 AWX 作业模板的执行，就像 Ansible 运行是 Ansible 行动手册的执行一样。

当您启动一个作业时，您会看到一个如下所示的窗口:

![](assets/e7d34166-9649-45fb-9c3a-de4dc0956bed.png)

当在命令行上运行时，这是 Ansible 输出的 AWX 版本。

几秒钟后，在右边的灰色框中，一个非常熟悉的输出将开始弹出，因为它与 Ansible 的`stdout`完全相同，只是在那里被重定向。

如果您稍后单击左侧菜单栏上的作业，您会发现自己在一个不同的屏幕上，列出了所有以前运行的作业:

![](assets/a1c73c44-3175-4b24-bc2b-f7d7773e834d.png)

正如您所注意到的，我们已经执行了两个作业，而我们只执行了演示作业模板。这是因为在执行演示作业模板之前，演示项目已经被拉出。这使得操作者总是能够放心地运行一个作业，知道它将总是 SCM 中可执行的最新版本。

# 摘要

在本章中，您已经学会了在 Fedora 上设置 AWX，并学会了使用 AWX 项目、库存、作业模板和作业。从 AWX 现有的选项、旗帜和物品的数量可以想象，这只是冰山一角，并不打算对此进行全面解释，因为这需要一本专门的书。

在下一章中，我们将讨论一些关于 AWX 用户、用户权限和组织的内容。