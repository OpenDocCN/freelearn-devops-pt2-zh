["```\n$ sudo pip3 install 'Ansible[Azure]'\n```", "```\n$ mkdir ch8_Azure\n```", "```\n$ pip3 list | grep Azure\n\nAzure-cli-core                 2.0.35\n\nAzure-cli-nspkg                3.0.2\n\nAzure-common                   1.1.11\n\nAzure-graphrbac                0.40.0\n\nAzure-keyvault                 1.0.0a1\n\n <<  ---  Output Omitted for brevity  -- >>\n```", "```\n$ cat hosts\n\n[az_net]\n\neu_az_net\n\nus_az_net\n\n[eu]\n\neu_az_net\n\n[us]\n\nus_az_net\n```", "```\n$ cat Ansible.cfg\n\n[defaults]\n\ninventory=hosts\n\nretry_files_enabled=False\n\ngathering=explicit\n\nhost_key_checking=False\n\naction_warnings=False\n```", "```\n$ cat group_var/eu.yml\n\n---\n\nregion: westeurope\n\n$ cat group_var/us.yml\n\n---\n\nregion: eastus \n```", "```\n$ echo \u2018AzureV@uLT2019\u2019 > .vault_pass\n```", "```\n$ Ansible-vault create Azure_secret.yml --vault-password-file=.vault_pass\n```", "```\n---\n\ntenant_id: XXX-XXXXXXXX\n\nclient_id: XXX-XXXX\n\nsubscription_id: XXX-XXXXX\n\nsecret: XXX-XXXX\n```", "```\n$ cat group_vars/eu.yml\n\nrg_name: \"rg_{{ inventory_hostname }}\"\n\n$ cat group_vars/eu.yml\n\nrg_name: \"rg_{{ inventory_hostname }}\"\n```", "```\n---\n- name: Build Azure Network Infrastructure\n hosts: all\n connection: local\n vars_files:\n - Azure_secret.yml\n tasks:\n - name: Create Resource group\n Azure_rm_resourcegroup:\n tenant: \"{{ tenant_id }}\"\n client_id: \"{{ client_id }}\"\n secret: \"{{ secret }}\"\n location: \"{{ region }}\"\n subscription_id: \"{{ subscription_id }}\"\n name: \"{{ rg_name }}\"\n state: \"{{ state | default('present') }}\"\n```", "```\n$ cat group_vars/eu.yml\nvnet_name: \"vn_{{ inventory_hostname }}\"\nvnet_cidr: 10.1.0.0/16\n$ cat group_vars/us.yml\nvnet_name: \"vn_{{ inventory_hostname }}\"\nvnet_cidr: 10.2.0.0/16\n```", "```\n    - name: Create Virtual Networks\n Azure_rm_virtualnetwork:\n tenant: \"{{ tenant_id }}\"\n client_id: \"{{ client_id }}\"\n secret: \"{{ secret }}\"\n location: \"{{ region }}\"\n subscription_id: \"{{ subscription_id }}\"\n resource_group: \"{{ rg_name}}\"\n name: \"{{ vnet_name }}\"\n address_prefixes_cidr: \"{{ vnet_cidr }}\"\n state: \"{{ state | default('present') }}\"\n```", "```\n$ cat group_vars/eu.yml\nsubnets:\n - name: web_tier\n cidr: 10.1.1.0/24\n - name: db_tier\n cidr: 10.1.2.0/24\n\n$ cat group_vars/us.yml\nsubnets:\n - name: web_tier\n cidr: 10.2.1.0/24\n - name: db_tier\n cidr: 10.2.2.0/24    \n```", "```\n - name: Create Subnets\n Azure_rm_subnet:\n tenant: \"{{ tenant_id }}\"\n client_id: \"{{ client_id }}\"\n secret: \"{{ secret }}\"\n subscription_id: \"{{ subscription_id }}\"\n resource_group: \"{{ rg_name}}\"\n name: \"{{ item.name}}\"\n virtual_network_name:  \"{{ vnet_name }}\"\n address_prefix_cidr: \"{{ item.cidr }}\"\n state: \"{{ state | default('present') }}\"\n loop: \"{{ subnets }}\"\n loop_control:\n label: \"{{ item.name }}\"\n```", "```\n$ cat group_vars/eu.yml  group_vars/us.yml\nroute_tables:\n - name: db_tier_rt\n subnet: db_tier\n routes:\n - name: Default Route\n prefix: 0.0.0.0/0\n nh: none\n```", "```\n - name: Create Custom Route Table\n Azure_rm_routetable:\n tenant: \"{{ tenant_id }}\"\n client_id: \"{{ client_id }}\"\n secret: \"{{ secret }}\"\n subscription_id: \"{{ subscription_id }}\"\n resource_group: \"{{ rg_name}}\"\n name: \"{{ item.name}}\"\n state: \"{{ state | default('present') }}\"\n loop: \"{{ route_tables }}\"\n tags: routing\n```", "```\n - name: Provision Routes\n Azure_rm_route:\n tenant: \"{{ tenant_id }}\"\n client_id: \"{{ client_id }}\"\n secret: \"{{ secret }}\"\n subscription_id: \"{{ subscription_id }}\"\n resource_group: \"{{ rg_name}}\"\n route_table_name: \"{{ item.0.name }}\"\n name: \"{{ item.1.name}}\"\n address_prefix: \"{{ item.1.prefix }}\"\n next_hop_type: \"{{ item.1.nh }}\"\n state: \"{{ state | default('present') }}\"\n with_subelements:\n - \"{{ route_tables }}\"\n - routes\n tags: routing\n```", "```\n - name: Attach Route Table to Subnet\n Azure_rm_subnet:\n tenant: \"{{ tenant_id }}\"\n client_id: \"{{ client_id }}\"\n secret: \"{{ secret }}\"\n subscription_id: \"{{ subscription_id }}\"\n resource_group: \"{{ rg_name}}\"\n name: \"{{ item.subnet}}\"\n virtual_network_name:  \"{{ vnet_name }}\"\n route_table: \"{{ item.name }}\"\n state: \"{{ state | default('present') }}\"\n loop: \"{{ route_tables }}\"\n loop_control:\n label: \"{{ item.name }}\"\n tags: routing\n```", "```\n$ cat group_vars/eu.yml  group_vars/us.yml\nacls:\n - name: Inbound_Web_Tier\n subnet: web_tier\n rules:\n - name: Allow_HTTP_Internet\n destination_address_prefix: 10.1.1.0/24\n direction: Inbound\n access: Allow\n protocol: Tcp\n destination_port_range:\n - 80\n - 443\n priority: 101\n```", "```\n - name: Create new Security Group\n Azure_rm_securitygroup:\n tenant: \"{{ tenant_id }}\"\n client_id: \"{{ client_id }}\"\n secret: \"{{ secret }}\"\n subscription_id: \"{{ subscription_id }}\"\n resource_group: \"{{ rg_name}}\"\n name: \"{{ item.name }}\"\n purge_rules: yes\n rules: \"{{ item.rules }}\"\n loop: \"{{ acls }}\"\n Tags: security\n```", "```\n - name: Attach Security Group to Subnet\n Azure_rm_subnet:\n tenant: \"{{ tenant_id }}\"\n client_id: \"{{ client_id }}\"\n secret: \"{{ secret }}\"\n subscription_id: \"{{ subscription_id }}\"\n resource_group: \"{{ rg_name}}\"\n name: \"{{ item.subnet}}\"\n virtual_network_name:  \"{{ vnet_name }}\"\n security_group: \"{{ item.name }}\"\n state: \"{{ state | default('present') }}\"\n loop: \"{{ acls }}\"\n tags: security\n```", "```\n$ cat ~/.Azure/credentials\n[default]\nsubscription_id=XXX-XXXX-XXXX\nclient_id=XXX-XXXX-XXXX\nsecret=XXX-XXXX-XXXX\ntenant=XXX-XXXX-XXXX\n```", "```\n$ cat pb_validate_Azure_net.yml\n- name: Build Azure Network Infrastructure\n hosts: all\n connection: local\n tasks:\n - name: Get Resource Facts\n Azure_rm_resourcegroup_facts:\n name: \"{{ rg_name }}\"\n register: rg_facts\n tags: rg_facts\n - name: Validate Resource Group is Deployed\n assert:\n that:\n - rg.name == rg_name\n - rg.properties.provisioningState == 'Succeeded'\n - rg.location == region\n loop: \"{{ Azure_resourcegroups }}\"\n loop_control:\n loop_var: rg\n tags: rg_facts\n```", "```\n    - name: Validate Virtual Network is Deployed\n      Azure_rm_virtualnetwork_facts:\n        resource_group: \"{{ rg_name }}\"\n      register: vnet_facts\n      tags: vnet_facts\n    - name: Validate Virtual Networks are Deployed\n      assert:\n        that:\n          - vnet.name == vnet_name\n          - vnet.properties.provisioningState == 'Succeeded'\n          - vnet.properties.addressSpace.addressPrefixes | length == 1\n          - vnet.properties.addressSpace.addressPrefixes[0] == vnet_cidr\n      loop: \"{{ Azure_virtualnetworks }}\"\n      loop_control:\n      loop_var: vnet\n      tags: vnet_facts\n```", "```\nok: [eu_az_net] => {\n \"Azure_resourcegroups\": [\n {\n \"id\": \"/subscriptions/bc20fdc0-70fa-46ef-9b80-3db8aa88a25c/resourceGroups/rg_eu_az_net\",\n \"location\": \"westeurope\",\n \"name\": \"rg_eu_az_net\",\n \"properties\": {\n \"provisioningState\": \"Succeeded\"\n }\n }\n ]\n}\n```", "```\n$ cat pb_destroy_Azure_net.yml\n---- name: Decomission Azure Infrastructure\n hosts: all\n connection: local\n vars:\n state: absent\n vars_files:\n - Azure_secret.yml\n tasks:\n - name: Delete Resource group\n Azure_rm_resourcegroup:\n tenant: \"{{ tenant_id }}\"\n client_id: \"{{ client_id }}\"\n secret: \"{{ secret }}\"\n location: \"{{ region }}\"\n subscription_id: \"{{ subscription_id }}\"\n name: \"{{ rg_name }}\"\n force_delete_nonempty: yes\n state: \"{{ state | default('present') }}\"\n```"]