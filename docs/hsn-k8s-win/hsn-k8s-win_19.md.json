["```\nssh azureuser@<dnsPrefix>.<azureLocation>.cloudapp.azure.com\n```", "```\nazureuser@k8s-master-50659983-0:~$ kubectl cluster-info dump\n...\n \"--etcd-servers=https://127.0.0.1:2379\",\n...\n```", "```\nazureuser@k8s-master-50659983-0:~$ sudo etcdctl cluster-health\nmember b3a6773c0e93604 is healthy: got healthy result from https://10.255.255.5:2379\nmember 721d9c3882dbe6f7 is healthy: got healthy result from https://10.255.255.7:2379\nmember 72b3415f69c52b2a is healthy: got healthy result from https://10.255.255.6:2379\ncluster is healthy\n```", "```\nsudo mkdir -p /backup\nETCDCTL_API=3 sudo -E etcdctl \\\n --endpoints=https://127.0.0.1:2379 \\\n --cacert=/etc/kubernetes/certs/ca.crt \\\n --cert=/etc/kubernetes/certs/etcdclient.crt \\\n --key=/etc/kubernetes/certs/etcdclient.key \\\n --debug \\\n snapshot save \\\n /backup/kubernetes-etcd-snapshot_$(date +\"%Y%m%d_%H%M%S\").db\n```", "```\nazureuser@k8s-master-50659983-0:~$ ETCDCTL_API=3 sudo -E etcdctl --write-out=table snapshot status /backup/kubernetes-etcd-snapshot_20191208_182555.db\n+----------+----------+------------+------------+\n|   HASH   | REVISION | TOTAL KEYS | TOTAL SIZE |\n+----------+----------+------------+------------+\n| b4422ea6 |    28331 |       1034 |     3.2 MB |\n+----------+----------+------------+------------+\n```", "```\nPS C:\\src> az ad sp create-for-rbac `\n --role=\"Storage Blob Data Contributor\" `\n --scopes=\"/subscriptions/<azureSubscriptionId>/resourceGroups/<aksEngineResourceGroupName>\"\n\nCreating a role assignment under the scope of \"/subscriptions/cc9a8166-829e-401e-a004-76d1e3733b8e/resourceGroups/aks-engine-windows-resource-group\"\n...\n{\n \"appId\": \"89694083-0110-4821-9510-a74eedf7a27c\",\n \"displayName\": \"azure-cli-2019-12-08-19-15-41\",\n \"name\": \"http://azure-cli-2019-12-08-19-15-41\",\n \"password\": \"67b1f492-caea-463f-ac28-69177f52fecf\",\n \"tenant\": \"86be0945-a0f3-44c2-8868-9b6aa96b0b62\"\n}\n```", "```\naz storage account create `\n --name aksenginebackups `\n --resource-group <aksEngineResourceGroupName> `\n --location <azureLocation> `\n --sku Standard_ZRS `\n --encryption blob\n```", "```\naz storage account keys list `\n --account-name $aksenginebackups `\n --resource-group <aksEngineResourceGroupName>\n```", "```\ncurl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash\n```", "```\naz login --service-principal \\\n   -u 1775963c-8414-434d-839c-db5d417c4293 \\\n   -p 276952a9-fa51-44ef-b6c6-905e322dbaed \\\n   --tenant 86be0945-a0f3-44c2-8868-9b6aa96b0b62\n```", "```\naz storage container create \\\n --account-name aksenginebackups \\\n --account-key \"<storageAccountKey>\" \\\n --name <dnsPrefix>\n```", "```\nsudo az storage blob upload \\\n --account-name aksenginebackups \\\n --account-key \"<storageAccountKey>\" \\\n --container-name <dnsPrefix> \\\n --name kubernetes-etcd-snapshot_20191208_182555.db \\\n --file /backup/kubernetes-etcd-snapshot_20191208_182555.db\n```", "```\nsudo rm /backup/kubernetes-etcd-snapshot_20191208_182555.db\n```", "```\nkubectl delete deployment -n dev-helm voting-application\n```", "```\nssh -L 5500:10.255.255.5:22 `\n -L 5501:10.255.255.6:22 `\n -L 5502:10.255.255.7:22 `\n azureuser@<dnsPrefix>.<azureLocation>.cloudapp.azure.com\n```", "```\n# Connection to Master 0 already established\n\n# Master 1\nssh azureuser@localhost -p 5501\n\n# Master 2\nssh azureuser@localhost -p 5502\n```", "```\ncurl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash\n```", "```\naz login --service-principal \\\n   -u 1775963c-8414-434d-839c-db5d417c4293 \\\n   -p 276952a9-fa51-44ef-b6c6-905e322dbaed \\\n   --tenant 86be0945-a0f3-44c2-8868-9b6aa96b0b62\n```", "```\naz storage blob download \\\n --account-name aksenginebackups \\\n --account-key \"<storageAccountKey>\" \\\n --container-name <dnsPrefix> \\\n --name kubernetes-etcd-snapshot_20191208_182555.db \\\n --file snapshot.db\n```", "```\ncat /etc/default/etcd\n```", "```\n--name k8s-master-50659983-0\n--initial-cluster k8s-master-50659983-0=https://10.255.255.5:2380,k8s-master-50659983-1=https://10.255.255.6:2380,k8s-master-50659983-2=https://10.255.255.7:2380\n--initial-cluster-token k8s-etcd-cluster\n--initial-advertise-peer-urls https://10.255.255.5:2380\n```", "```\n# Master 0\nETCDCTL_API=3 sudo -E etcdctl snapshot restore snapshot.db \\\n --name k8s-master-50659983-0 \\\n --initial-cluster k8s-master-50659983-0=https://10.255.255.5:2380,k8s-master-50659983-1=https://10.255.255.6:2380,k8s-master-50659983-2=https://10.255.255.7:2380 \\\n --initial-cluster-token k8s-etcd-cluster \\\n --initial-advertise-peer-urls https://10.255.255.5:2380 \\\n --data-dir=/var/lib/etcddisk-restored \\\n --debug\n\n# Master 1\nETCDCTL_API=3 sudo -E etcdctl snapshot restore snapshot.db \\\n --name k8s-master-50659983-1 \\\n --initial-cluster k8s-master-50659983-0=https://10.255.255.5:2380,k8s-master-50659983-1=https://10.255.255.6:2380,k8s-master-50659983-2=https://10.255.255.7:2380 \\\n --initial-cluster-token k8s-etcd-cluster \\\n --initial-advertise-peer-urls https://10.255.255.6:2380 \\\n --data-dir=/var/lib/etcddisk-restored \\\n --debug\n\n# Master 2\nETCDCTL_API=3 sudo -E etcdctl snapshot restore snapshot.db \\\n --name k8s-master-50659983-2 \\\n --initial-cluster k8s-master-50659983-0=https://10.255.255.5:2380,k8s-master-50659983-1=https://10.255.255.6:2380,k8s-master-50659983-2=https://10.255.255.7:2380 \\\n --initial-cluster-token k8s-etcd-cluster \\\n --initial-advertise-peer-urls https://10.255.255.7:2380 \\\n --data-dir=/var/lib/etcddisk-restored \\\n --debug\n```", "```\nsudo mv /etc/kubernetes/manifests /etc/kubernetes/manifests-stopped\n```", "```\nsudo service etcd stop\n```", "```\nsudo service kubelet stop\n```", "```\ndocker stop $(docker ps -q)\n```", "```\n# Backing up old data directory\nsudo mkdir /var/lib/etcddisk-old\nsudo mv /var/lib/etcddisk/member /var/lib/etcddisk-old/\n\n# Move the contents of the snapshot directory to the target data directory\nsudo mv /var/lib/etcddisk-restored/member /var/lib/etcddisk/\nsudo chown etcd -R /var/lib/etcddisk\nsudo chgrp etcd -R /var/lib/etcddisk\nsudo ls -al /var/lib/etcddisk/member/\n\n# Cleanup\nsudo rm -rf /var/lib/etcddisk-restored\n```", "```\nsudo service etcd start\n```", "```\nsudo mv /etc/kubernetes/manifests-stopped /etc/kubernetes/manifests\n```", "```\nsudo service kubelet start\n```", "```\nPS C:\\src> kubectl get pods --all-namespaces\nNAMESPACE     NAME                                               READY   STATUS              RESTARTS   AGE\ndev-helm      voting-application-8477c76b67-4lkrm                0/1     CrashLoopBackOff    6          9h\ndev-helm      voting-application-8477c76b67-7tbmw                0/1     CrashLoopBackOff    6          9h\ndev-helm      voting-application-8477c76b67-dls6q                0/1     ContainerCreating   7          9h\ndev-helm      voting-application-8477c76b67-dvcqz                0/1     ContainerCreating   7          9h\ndev-helm      voting-application-8477c76b67-xttml                0/1     CrashLoopBackOff    9          9h\ndev-helm      voting-application-mssql-linux-8548b4dd44-hdrpc    0/1     ContainerCreating   0          9h\nkube-system   azure-cni-networkmonitor-6dr8c                     1/1     Running             1          9h\nkube-system   azure-cni-networkmonitor-dhgsv                     1/1     Running             0          9h\n...\n```", "```\nFROM ubuntu:18.04\n\nARG ETCD_VERSION=\"v3.3.15\"\n\nWORKDIR /temp\nRUN apt-get update \\\n && apt-get install curl -y \\\n && curl -L https://github.com/coreos/etcd/releases/download/$ETCD_VERSION/etcd-$ETCD_VERSION-linux-amd64.tar.gz -o etcd-$ETCD_VERSION-linux-amd64.tar.gz \\\n && tar xzvf etcd-$ETCD_VERSION-linux-amd64.tar.gz \\\n && rm etcd-$ETCD_VERSION-linux-amd64.tar.gz \\\n && cd etcd-$ETCD_VERSION-linux-amd64 \\\n && cp etcdctl /usr/local/bin/ \\\n && rm -rf etcd-$ETCD_VERSION-linux-amd64\n\nRUN curl -sL https://aka.ms/InstallAzureCLIDeb | bash\n\nWORKDIR /backup-worker\nCOPY ./docker-entrypoint.sh .\nRUN chmod +x docker-entrypoint.sh\n\nENTRYPOINT [\"/backup-worker/docker-entrypoint.sh\"]\n```", "```\n#!/bin/bash\n\nsnapshot_file=\"kubernetes-etcd-snapshot_$(date +\"%Y%m%d_%H%M%S\").db\"\n\nETCDCTL_API=3 etcdctl \\\n   --endpoints=$SNAPSHOT_ETCD_ENDPOINTS \\\n   --cacert=/etc/kubernetes/certs/ca.crt \\\n   --cert=/etc/kubernetes/certs/etcdclient.crt \\\n   --key=/etc/kubernetes/certs/etcdclient.key \\\n   --debug \\\n   snapshot save \\\n   $snapshot_file\n\nETCDCTL_API=3 etcdctl --write-out=table snapshot status $snapshot_file\n\naz login --service-principal \\\n   -u $SNAPSHOT_AZURE_PRINCIPAL_APPID \\\n   -p $SNAPSHOT_AZURE_PRINCIPAL_PASSWORD \\\n   --tenant $SNAPSHOT_AZURE_PRINCIPAL_TENANT\n\naz storage container create \\\n   --account-name $SNAPSHOT_AZURE_ACCOUNT_NAME \\\n   --account-key \"$SNAPSHOT_AZURE_ACCOUNT_KEY\" \\\n   --name $SNAPSHOT_AZURE_CONTAINER_NAME\n\naz storage blob upload \\\n   --account-name $SNAPSHOT_AZURE_ACCOUNT_NAME \\\n   --account-key \"$SNAPSHOT_AZURE_ACCOUNT_KEY\" \\\n   --container-name $SNAPSHOT_AZURE_CONTAINER_NAME \\\n   --name $snapshot_file \\\n   --file $snapshot_file\n\nrm -f $snapshot_file\n\necho \"Backup $snapshot_file uploaded successfully!\"\n```", "```\ndocker build -t <dockerId>/aks-engine-etcd-snapshot-azure-blob-job .\n```", "```\ndocker tag <dockerId>/aks-engine-etcd-snapshot-azure-blob-job:latest <dockerId>/aks-engine-etcd-snapshot-azure-blob-job:1.0.0\ndocker push <dockerId>/aks-engine-etcd-snapshot-azure-blob-job\n```", "```\ndocker run \\\n -v /etc/kubernetes/certs:/etc/kubernetes/certs \\\n -e SNAPSHOT_ETCD_ENDPOINTS=https://10.255.255.5:2379,https://10.255.255.6:2379,https://10.255.255.7:2379 \\\n -e SNAPSHOT_AZURE_PRINCIPAL_APPID=1775963c-8414-434d-839c-db5d417c4293 \\\n -e SNAPSHOT_AZURE_PRINCIPAL_PASSWORD=276952a9-fa51-44ef-b6c6-905e322dbaed \\\n -e SNAPSHOT_AZURE_PRINCIPAL_TENANT=86be0945-a0f3-44c2-8868-9b6aa96b0b62 \\\n -e SNAPSHOT_AZURE_ACCOUNT_NAME=aksenginebackups \\\n -e SNAPSHOT_AZURE_ACCOUNT_KEY=\"<storageAccountKey>\" \\\n -e SNAPSHOT_AZURE_CONTAINER_NAME=<dnsPrefix> \\\n packtpubkubernetesonwindows/aks-engine-etcd-snapshot-azure-blob-job:1.0.0\n```", "```\nSNAPSHOT_ETCD_ENDPOINTS=https://10.255.255.5:2379,https://10.255.255.6:2379,https://10.255.255.7:2379\nSNAPSHOT_AZURE_PRINCIPAL_APPID=1775963c-8414-434d-839c-db5d417c4293\nSNAPSHOT_AZURE_PRINCIPAL_PASSWORD=276952a9-fa51-44ef-b6c6-905e322dbaed\nSNAPSHOT_AZURE_PRINCIPAL_TENANT=86be0945-a0f3-44c2-8868-9b6aa96b0b62\nSNAPSHOT_AZURE_ACCOUNT_NAME=aksenginebackups\nSNAPSHOT_AZURE_ACCOUNT_KEY=\"<dnsPrefix>\"\nSNAPSHOT_AZURE_CONTAINER_NAME=<dnsPrefix>\n```", "```\nkubectl create secret generic `\n -n kube-system `\n etcd-snapshot-azure-blob-job-secrets `\n --from-env-file=etcd-snapshot-secrets.txt\n```", "```\napiVersion: batch/v1beta1\nkind: CronJob\nmetadata:\n  name: etcd-snapshot-azure-blob-job\n  namespace: kube-system\nspec:\n  schedule: \"0 */6 * * *\" # (1)\nsuccessfulJobsHistoryLimit: 2\n  failedJobsHistoryLimit: 2\n  jobTemplate:\n    spec:\n      ttlSecondsAfterFinished: 21600\n      activeDeadlineSeconds: 600\n      template:\n        spec:\n          tolerations:\n          - key: node-role.kubernetes.io/master  # (2)\n operator: Exists\n effect: NoSchedule\n nodeSelector:\n node-role.kubernetes.io/master: \"\"\n          containers:\n          - name: snapshot-worker\n            image: packtpubkubernetesonwindows/aks-engine-etcd-snapshot-azure-blob-job:1.0.0  # (3)\n            volumeMounts:\n            - mountPath: /etc/kubernetes/certs\n              name: etcd-certs\n            envFrom:\n            - secretRef:\n                name: etcd-snapshot-azure-blob-job-secrets  # (4)\n          volumes:\n          - name: etcd-certs\n            hostPath:\n              path: /etc/kubernetes/certs  # (5)\n          restartPolicy: Never\n          hostNetwork: true\n```", "```\nPS C:\\src> kubectl get cronjob -n kube-system -w\nNAME                           SCHEDULE      SUSPEND   ACTIVE   LAST SCHEDULE   AGE\netcd-snapshot-azure-blob-job   0 */6 * * *   False     0        2m              16m\n```", "```\nssh azureuser@<dnsPrefix>.<azureLocation>.cloudapp.azure.com\n```", "```\nazureuser@k8s-master-50659983-0:~$ sudo etcdctl cluster-health\nmember b3a6773c0e93604 is healthy: got healthy result from https://10.255.255.5:2379\nmember 721d9c3882dbe6f7 is healthy: got healthy result from https://10.255.255.7:2379\nmember 72b3415f69c52b2a is healthy: got healthy result from https://10.255.255.6:2379\ncluster is healthy\n```", "```\nsudo service etcd stop\n```", "```\nazureuser@k8s-master-50659983-0:~$ sudo etcdctl --endpoints=https://10.255.255.6:2379,https://10.255.255.7:2379 cluster-health\nfailed to check the health of member b3a6773c0e93604 on https://10.255.255.5:2379: Get https://10.255.255.5:2379/health: dial tcp 10.255.255.5:2379: connect: connection refused\nmember b3a6773c0e93604 is unreachable: [https://10.255.255.5:2379] are all unreachable\nmember 721d9c3882dbe6f7 is healthy: got healthy result from https://10.255.255.7:2379\nmember 72b3415f69c52b2a is healthy: got healthy result from https://10.255.255.6:2379\ncluster is degraded\n```", "```\nazureuser@k8s-master-50659983-0:~$ sudo etcdctl --endpoints=https://10.255.255.6:2379,https://10.255.255.7:2379 member remove b3a6773c0e93604\nRemoved member b3a6773c0e93604 from cluster\n```", "```\nazureuser@k8s-master-50659983-0:~$ sudo etcdctl --endpoints=https://10.255.255.6:2379,https://10.255.255.7:2379 member add k8s-master-50659983-0-replace-0 https://10.255.255.5:2380\nAdded member named k8s-master-50659983-0-replace-0 with ID af466a622a247b09 to cluster\n```", "```\nsudo mkdir /var/lib/etcddisk-replace-0\nsudo chown etcd /var/lib/etcddisk-replace-0\nsudo chgrp etcd /var/lib/etcddisk-replace-0\n```", "```\nsudo service etcd start\n```", "```\nazureuser@k8s-master-50659983-0:~$ sudo etcdctl --endpoints=https://10.255.255.6:2379,https://10.255.255.7:2379 cluster-health\nmember 1f5a8b7d5b2a5b68 is healthy: got healthy result from https://10.255.255.5:2379\nmember 721d9c3882dbe6f7 is healthy: got healthy result from https://10.255.255.7:2379\nmember 72b3415f69c52b2a is healthy: got healthy result from https://10.255.255.6:2379\ncluster is healthy\n```"]