# 第二章：介绍云中的无服务器

## 学习目标

在本章结束时，您将能够：

+   评估选择最佳无服务器 FaaS 提供商的标准

+   识别主要云服务提供商支持的语言、触发类型和成本结构

+   将无服务器函数部署到云提供商并将函数与其他云服务集成

在本章中，我们将解释云提供商的无服务器 FaaS 产品，创建我们在云中的第一个无服务器函数，并与其他云服务集成。

## 介绍

在上一章中，讨论了传统架构向无服务器设计的架构演变。此外，介绍了无服务器的起源和好处，以解释其在行业中的高采用率和成功。在本章中，重点将放在云提供商的无服务器平台上。让我们从多年来云技术提供的演变开始。

在云计算开始时，云提供商的主要提供是其预配和可立即使用的硬件，即**基础设施**。云提供商管理硬件和网络操作，因此，他们提供的产品是**基础设施即服务**（**IaaS**），如下图所示。所有云提供商仍然将 IaaS 产品作为其核心功能，比如 AWS 的**Amazon 弹性计算云（Amazon EC2）**和 GCP 的**Google 计算引擎**。

在接下来的几年里，云提供商开始提供平台，开发人员只能在其上运行他们的应用程序。通过这种抽象，手动服务器配置、安全更新和服务器故障成为了云提供商的关注点。这些提供被称为**平台即服务**（**PaaS**），因为它们只专注于在其平台上运行应用程序和数据。**Heroku**是最受欢迎的 PaaS 提供商，尽管每个云提供商都有自己的 PaaS 产品，比如**AWS 弹性 Beanstalk**或**Google App Engine**。与 IaaS 类似，PaaS 在软件开发中仍在使用。

在顶层抽象中，应用程序的功能作为无服务器架构中的控制单元。这被称为**函数即服务**（**FaaS**），近年来所有重要的云提供商都提供了这种抽象。从 IaaS 到 PaaS，最终到 FaaS 的抽象层次可以在下图中看到：

![图 2.1：从 IaaS 到 PaaS 和 FaaS 的转变](img/C12607_02_01.jpg)

###### 图 2.1：从 IaaS 到 PaaS 和 FaaS 的转变

### 无服务器和云评估标准

为了分析市场上的 FaaS 产品，定义一些标准是有益的，这样我们就可以以结构化的方式比较产品。在选择云提供商之前，以下主题对于每个 FaaS 平台都是必不可少的，并需要进行详细调查：

+   **编程语言：** 函数部署和管理在云提供商的环境中。因此，云提供商定义支持的编程语言。这是最重要的决策因素之一，因为在大多数情况下，使用其他语言实现函数是不可行的。

+   **功能触发器：** 函数设计为由云提供商服务和外部方法触发。传统的技术包括定时调用、按需调用以及与其他云服务（如数据库、队列和 API 网关）的集成。

+   **成本：** 无服务器架构最具吸引力的特点是其成本效益和主流的价格计算方式，即按请求付费。对于长期运行的项目的可行性，计算实际和预期成本是至关重要的。

云提供商应该具有成本效益，尽可能提供多种编程语言，并支持各种功能触发器。还有其他标准，如监控、运维和内部知识水平，但这些与云提供商的无服务器产品并不直接相关。在接下来的章节中，将讨论三个最主要的云提供商的无服务器平台：亚马逊云服务、谷歌云平台和微软 Azure。

### AWS Lambda

AWS Lambda 是第一个 FaaS 提供，也在行业中引起了无服务器的热潮。它于 2014 年公开，并被各级组织广泛采用于云计算世界。它使初创公司能够在短时间内创建新产品。它还使像 Netflix 这样的大型企业能够将基于事件的触发器转移到无服务器功能上。通过消除服务器操作负担的机会，AWS Lambda 和无服务器成为了行业的下一个趋势。在本节中，我们将讨论 AWS Lambda 的编程语言支持、触发器类型和成本结构。此外，我们将部署我们的第一个无服务器函数。

#### 注意

如果您想了解更多信息，可以在此处找到 AWS Lambda 的官方网站：[`aws.amazon.com/lambda`](https://aws.amazon.com/lambda)。

AWS Lambda 在无服务器函数方面支持 Java、Python、Node.js、C#、Ruby 和 Go 编程语言。此外，AWS Lambda 提供了一个名为 AWS Lambda Runtime Interface 的 API，以实现任何语言作为自定义运行时的集成。因此，可以说 AWS Lambda 本地支持一组流行的语言，同时允许扩展到其他编程语言。

AWS Lambda 旨在具有事件触发功能。这是函数处理从事件源检索到的事件的地方。在 AWS 生态系统中，各种服务都可以是事件源，包括以下内容：

+   亚马逊 S3 文件存储用于添加新文件时

+   亚马逊 Alexa 用于实现语音助手的新技能

+   亚马逊 CloudWatch Events 用于云资源状态更改时发生的事件

+   亚马逊 CodeCommit 用于开发人员向代码存储库推送新提交时

除了这些服务之外，无服务器事件源的基本 AWS 服务是**Amazon API Gateway**。它具有通过 HTTPS 调用 Lambda 函数的 REST API 功能，并允许管理多个 Lambda 函数以用于不同的方法，如`GET`、`POST`、`PATCH`和`DELETE`。换句话说，API Gateway 在无服务器函数和外部世界之间创建了一个层。这一层还通过保护 Lambda 函数免受**分布式拒绝服务**（**DDoS**）攻击和定义节流来处理 Lambda 函数的安全性。如果要与其他 AWS 服务集成或通过 API Gateway 公开它们，AWS Lambda 函数的触发器类型和环境是高度可配置的。

对于 AWS Lambda 的定价，有两个关键点需要注意：第一个是**请求费用**，第二个是**计算费用**。请求费用是基于函数调用次数计算的，而计算费用是按每秒 GB 计算的。计算费用是内存大小和执行时间的乘积：

+   **内存大小（GB）**：这是函数配置的分配内存。

+   **执行时间（毫秒）**：这是函数实际运行的执行时间。

此外，还有一个免费套餐，其中每月免除前 100 万次请求费用和每秒 400,000 GB 的计算费用。包括免费套餐在内的简单计算可以显示运行无服务器函数的成本是多么便宜。

假设您的函数一个月被调用了 3000 万次。您已经分配了 128 MB 的内存，平均来说，函数运行了 200 毫秒：

*请求费用：*

**价格**：每 100 万次请求$0.20

**免费套餐**：100 万次

**月请求**：30 M

**月请求费用**：29 M x $0.20 / M = $5.80

*计算费用：*

**价格**：每 GB 每秒$0.0000166667

**免费套餐**：每秒 400,000 GB

**月计算**：30 M x 0.2 秒 x 128 MB / 1024 = 750,000 GB 每秒

**月计算费用**：350,000 x $0.0000166667 = $5.83

**月总成本**：$5.80 + $5.83 = $11.63

这个计算表明，在运行一个无服务器的 AWS Lambda 环境中，每天接收*100 万次函数调用的月成本为 11.63 美元*。这表明了运行无服务器工作负载的成本是多么便宜，以及在无服务器经济中需要考虑的基本特征。在接下来的练习中，我们的第一个无服务器函数将部署到 AWS Lambda，并将被调用以显示平台的操作视图。

#### 注意

为了完成这个练习，您需要拥有一个活跃的亚马逊网络服务账户。您可以在[`aws.amazon.com/`](https://aws.amazon.com/)上创建一个账户。

### 练习 4：在 AWS Lambda 中创建函数并通过 AWS Gateway API 调用它

在这个练习中，我们将创建我们的第一个 AWS Lambda 函数，并将其连接到 AWS Gateway API，以便我们可以通过其 HTTP 端点调用。

要成功完成此练习，我们需要确保执行以下步骤：

1.  打开 AWS 管理控制台，在**查找服务**搜索框中输入**Lambda**，然后单击**Lambda - Run Code without Thinking about Servers**。控制台将如下所示：![图 2.2：AWS 管理控制台](img/C12607_02_02.jpg)

###### 图 2.2：AWS 管理控制台

1.  单击 Lambda 函数列表中的**创建函数**，如下截图所示：![图 2.3：AWS Lambda - 函数列表](img/C12607_02_03.jpg)

###### 图 2.3：AWS Lambda - 函数列表

1.  在**创建函数**视图中选择**从头开始**。将`hello-from-lambda`作为函数名称，`Python 3.7`作为运行时。单击屏幕底部的**创建函数**，如下截图所示：![图 2.4：AWS Lambda - 创建函数视图](img/C12607_02_04.jpg)

###### 图 2.4：AWS Lambda - 创建函数视图

1.  您将被引导到**hello-from-lambda**函数视图，这是您

1.  可以编辑**函数代码**，如下截图所示：![图 2.5：AWS Lambda - hello-from-lambda](img/C12607_02_05.jpg)

###### 图 2.5：AWS Lambda - hello-from-lambda

1.  更改`lambda_handler`函数如下：

```
import json
def lambda_handler(event, context):
    return {
        'statusCode': '200',
        'body': json.dumps({"message": "hello", "platform": "lambda"}),
        'headers': {
            'Content-Type': 'application/json',
        }
    }
```

1.  单击屏幕顶部的**保存**，如下截图所示：![图 2.6：AWS Lambda - hello-from-lambda 函数代码](img/C12607_02_06.jpg)

###### 图 2.6：AWS Lambda - hello-from-lambda 函数代码

1.  打开**设计**视图，点击**添加触发器**，如下面的屏幕截图所示：![图 2.7：AWS Lambda – hello-from-lambda 设计视图](img/C12607_02_07.jpg)

###### 图 2.7：AWS Lambda – hello-from-lambda 设计视图

1.  从触发器列表中选择**API Gateway**，如下面的屏幕截图所示：![图 2.8：AWS Lambda – 触发器列表](img/C12607_02_08.jpg)

###### 图 2.8：AWS Lambda – 触发器列表

1.  在触发器配置屏幕上选择**创建新的 API**作为 API，并且选择**开放**作为**安全**配置，如下面的屏幕截图所示：![图 2.9：AWS Lambda – 触发器配置](img/C12607_02_09.jpg)

###### 图 2.9：AWS Lambda – 触发器配置

在这个屏幕上，已经在 API Gateway 中为`hello-from-lambda`函数定义了一个新的 API，并且开放了安全性。这个配置确保了一个端点将被创建，并且它将可以在没有任何身份验证的情况下访问。

1.  在屏幕底部点击**添加**。

您将被重定向到`hello-from-lambda`函数，通知显示**该函数现在正在接收来自触发器的事件**。在**设计**视图中，Lambda 函数连接到 API Gateway 以进行触发，并连接到 Amazon CloudWatch Logs 以进行日志记录。换句话说，现在可以通过 API Gateway 端点触发函数，并在 CloudWatch 中检查它们的输出，如下面的屏幕截图所示：

![图 2.10：AWS Lambda – 添加触发器](img/C12607_02_10.jpg)

###### 图 2.10：AWS Lambda – 添加触发器

1.  从 API Gateway 部分获取 API Gateway 端点，如下面的屏幕截图所示：![图 2.11：AWS Lambda – 触发器 URL](img/C12607_02_11.jpg)

###### 图 2.11：AWS Lambda – 触发器 URL

1.  在新标签页中打开 URL 来触发函数并获取响应，如下面的屏幕截图所示：![图 2.12：AWS Lambda – 函数响应](img/C12607_02_12.jpg)

###### 图 2.12：AWS Lambda – 函数响应

这个 JSON 响应表明 AWS Lambda 函数通过 API Gateway 连接并且按预期工作。

1.  从第 2 步返回到**函数**列表，选择`hello-from-lambda`，并从**操作**中选择**删除**。然后，点击弹出窗口中的**删除**以从 Lambda 中删除该函数，如下面的屏幕截图所示：![图 2.13：AWS Lambda – 函数删除](img/C12607_02_13.jpg)

###### 图 2.13：AWS Lambda – 函数删除

在这个练习中，展示了创建 AWS Lambda 函数并连接到 AWS Gateway API 以进行 HTTP 访问的一般流程。在不到 10 个步骤的时间内，就可以在 AWS Lambda 云环境中运行生产就绪的服务。这个练习向您展示了无服务器平台如何使软件开发变得快速简单。在接下来的部分中，将继续分析云提供商的无服务器平台，其中包括 Microsoft 的 Azure Functions。

### Azure Functions

微软于 2016 年宣布了**Azure Functions**，作为**Microsoft Azure**云中的无服务器平台。Azure Functions 通过来自 Azure 或外部服务的事件触发器来运行无服务器工作负载，从而扩展了其云平台。它的特色在于专注于行业中广泛使用的 Microsoft 支持的编程语言和工具。在本节中，将从支持的编程语言、触发器类型和成本方面讨论 Azure Functions。最后，我们将部署一个从端点接收参数的函数到 Azure Functions，以说明其操作方面。

#### 注意

如果您想了解更多信息，可以在这里找到 Azure Functions 的官方网站：[`azure.microsoft.com/en-us/services/functions/`](https://azure.microsoft.com/en-us/services/functions/)。

Azure Functions 的最新版本支持**C#**，**JavaScript**（在**Node.js**运行时），**F#**，**Java**，**PowerShell**，**Python**和**Typescript**，它会被转译成**JavaScript**。此外，提供了一种语言可扩展性接口，用于在**gRPC**作为消息层的函数运行时和工作进程之间进行通信。在开始使用之前，了解 Azure Functions 支持的普遍可用的、实验性的和可扩展的编程语言是很有价值的。

#### 注意

`gRPC`是一个最初由 Google 开发的**远程过程调用**（**RPC**）系统。它是一个开源系统，可以实现跨平台通信，没有语言或平台限制。

Azure Functions 旨在由各种类型触发，例如定时器、HTTP、文件操作、队列消息和事件。此外，可以为函数指定输入和输出绑定。这些绑定定义了函数的输入参数和要发送到其他服务的输出值。例如，可以创建一个定时函数来从 Blob Storage 中读取文件，并将 Cosmos DB 文档创建为输出。在这个例子中，函数可以使用**定时器触发器**、**Blob Storage**输入绑定和**Cosmos DB**输出绑定进行定义。触发器和绑定使 Azure Functions 轻松集成到 Azure 服务和外部世界中。

与 AWS Lambda 相比，Azure Functions 的成本计算方法和当前价格有两个不同之处。第一个区别是 Azure Functions 的当前计算价格略低，为每秒$0.000016/GB。第二个区别是 Azure Functions 使用观察到的内存消耗进行计算，而 AWS Lambda 中内存限制是预先配置的。

在接下来的练习中，第一个无服务器函数将被部署到 Azure Functions，并将被调用以显示平台的操作视图。

#### 注意

为了完成这项练习，您需要拥有一个活跃的 Azure 账户。您可以在[`signup.azure.com/`](https://signup.azure.com/)上创建一个账户。

### 练习 5：在 Azure Functions 中创建一个带参数的函数

在这个练习中，我们的目标是在 Azure 中创建一个带参数的函数，并通过其 HTTP 端点以不同的参数进行调用。

为了成功完成这项练习，我们需要确保执行以下步骤：

1.  在**Azure**首页的左侧菜单中点击**Function App**，如下截图所示：![图 2.14：Azure 首页](img/C12607_02_14.jpg)

###### 图 2.14：Azure 首页

1.  从**Function App**列表中点击**创建函数应用**，如下截图所示：![图 2.15：函数应用列表](img/C12607_02_15.jpg)

###### 图 2.15：函数应用列表

1.  给应用取一个唯一的名称，比如`hello-from-azure`，并选择**Node.js**作为**Runtime Stack**。点击页面底部的**创建**，如下截图所示：![图 2.16：创建一个函数应用](img/C12607_02_16.jpg)

###### 图 2.16：创建一个函数应用

1.  您将被重定向到**函数应用**列表视图。检查菜单顶部是否有通知。您将看到**正在部署到资源组'hello-from-azure'**，如下图所示：![图 2.17：部署正在进行中](img/C12607_02_17.jpg)

###### 图 2.17：部署正在进行中

等待几分钟，直到部署完成：

![图 2.18：成功部署](img/C12607_02_18.jpg)

###### 图 2.18：成功部署

1.  在`hello-from-azure`函数应用视图中点击**+新函数**，如下图所示：![图 2.19：hello-from-azure 函数应用](img/C12607_02_19.jpg)

###### 图 2.19：hello-from-azure 函数应用

1.  选择**In-portal**作为开发环境，在 Azure Web 门户内创建函数，并单击**继续**，如下图所示：![图 2.20：函数开发环境](img/C12607_02_20.jpg)

###### 图 2.20：函数开发环境

1.  选择**Webhook + API**，然后单击**创建**，如下图所示：![图 2.21：函数触发器类型](img/C12607_02_21.jpg)

###### 图 2.21：函数触发器类型

在此视图中，可以从模板创建函数，例如 webhooks、定时器或来自市场的协作模板。

1.  将以下函数写入`index.js`，然后单击**保存**：

```
module.exports = async function (context, req) {
    context.log('JavaScript HTTP trigger function processed a request.');
    if (req.query.name || (req.body && req.body.name)) {
        context.res = {
            status: 200,
            body: "Hello " + (req.query.name || req.body.name) +", it is your function in Azure!"
        };
    }
    else {
        context.res = {
            status: 400,
            body: "Please pass a name on the query string or in the request body."
        };
    }
};
```

此代码导出一个接受来自请求的参数的函数。该函数创建一个个性化消息，并将其作为输出发送给用户。代码应该插入到代码编辑器中，如下图所示：

![图 2.22：hello-from-azure 函数的 index.js](img/C12607_02_22.jpg)

###### 图 2.22：hello-from-azure 函数的 index.js

1.  点击**获取函数 URL**并复制弹出窗口中的 URL，如下图所示

1.  下面的屏幕截图：![图 2.23：函数 URL](img/C12607_02_23.jpg)

###### 图 2.23：函数 URL

1.  在浏览器中打开您在*步骤 7*中复制的 URL，如下面的屏幕截图所示：![图 2.24：没有参数的函数响应](img/C12607_02_24.jpg)

###### 图 2.24：没有参数的函数响应

在 URL 的末尾添加**&name=**和您的名字，然后重新加载选项卡，例如`https://hello-from-azure.azurewebsites.net/api/HttpTrigger?code=nNrck...&name=Onur`，如下面的屏幕截图所示：

![图 2.25：带参数的函数响应](img/C12607_02_25.jpg)

###### 图 2.25：带参数的函数响应

这些响应表明可以验证和传递参数给函数。对于无服务器函数以及考虑各种触发器和绑定的可能性时，传递参数及其验证是至关重要的。

1.  从*步骤 2*返回**函数应用**列表，单击我们创建的新函数旁边的**...**，然后选择**删除**，如下面的屏幕截图所示：![图 2.26：删除函数](img/C12607_02_26.jpg)

###### 图 2.26：删除函数

在弹出视图中输入函数名称，然后单击**删除**以删除所有资源。在确认视图中，警告指示函数应用的删除是不可逆的，如下面的屏幕截图所示：

![图 2.27：删除函数及其资源](img/C12607_02_27.jpg)

###### 图 2.27：删除函数及其资源

在下一节中，将以类似的方式讨论谷歌云函数，并将更复杂的函数部署到云提供商。

### 谷歌云函数

谷歌云函数于 2017 年公开发布，就在 AWS Lambda 和 Azure Functions 之后。在谷歌云函数发布之前，PaaS 产品谷歌的**Firebase**已经支持无服务器函数。然而，谷歌云函数作为其核心无服务器云产品，已经对谷歌云平台内的所有服务开放。在本节中，将讨论谷歌云函数支持的编程语言、触发器类型和成本。最后，我们将部署一个定期被云服务调用的函数到谷歌云函数，以展示其操作方面。

#### 注意

如果您想了解更多信息，可以在谷歌云函数的官方网站找到：[`cloud.google.com/functions/`](https://cloud.google.com/functions/)。

**谷歌云函数**（**GCF**）可以使用**Node.js**、**Python**和**Go**进行开发。与其他主要云提供商相比，GCF 支持的语言范围较小。此外，GCF 不支持公开可用的语言扩展或 API。因此，评估 GCF 支持的语言是否适用于您将开发的函数至关重要。

Google Cloud Functions 旨在与触发器和事件相关联。事件发生在您的云服务中，例如数据库更改、存储系统中的新文件，或者在提供新虚拟机时。触发器是将服务和相关事件声明为函数输入的声明。可以创建触发器作为**HTTP**端点、**Cloud Pub/Sub**队列消息，或存储服务，如**Cloud Storage**和**Cloud Firestore**。此外，函数可以连接到 Google Cloud Platform 提供的大数据和机器学习服务。

与其他云提供商相比，Google Cloud Platform 的成本计算略微复杂。这是因为它考虑了调用、计算时间和出站网络数据，而其他云提供商只关注调用和计算时间：

+   **调用**：每一百万请求收取 0.40 美元。

+   **计算时间**：函数的计算时间从调用开始到完成，以 100 毫秒为增量计算。例如，如果您的函数完成需要 240 毫秒，您将被收取 300 毫秒的计算时间费用。在这个计算中使用了两个单位 - **每秒 GB** 和 **每秒 GHz**。为运行 1 秒的函数提供 1GB 内存，每秒 1GB 的价格为 0.0000025 美元。此外，为运行 1 秒的函数提供 1GHz 的 CPU，每秒 1GHz 的价格为 0.0000100 美元。

+   **出站网络数据**：从函数传输到外部的数据以 GB 计量，每 GB 数据收取 0.12 美元。

GCF 的免费套餐提供了 200 万次调用、每秒 400,000GB、每秒 200,000GHz 的计算时间，以及每月 5GB 的出站网络流量。与 AWS 或 Azure 相比，GCP 的成本会略高，因为它的价格更高，计算方法更复杂。

假设您的函数一个月被调用了 3000 万次。您已经分配了 128MB 内存，200MHz 的 CPU，并且平均来说，函数运行时间为 200 毫秒，类似于 AWS Lambda 的例子：

*请求费用*

**价格**：每 1 百万请求 0.40 美元

**免费套餐**：2 百万

**每月请求**：30 百万

**每月请求费用** = 28 百万 x 0.40 / 百万 = 11.2 美元

*计算费用 - 内存：*

**价格**：每 GB 秒 0.0000025 美元

**免费套餐**：400,000GB 秒

**每月计算**：30 M x 0.2 秒 x 128 MB / 1024 = 750,000 GB 秒

**每月内存费用**：350,000 x $0.0000025 = $0.875

*计算费用 - CPU：*

**价格**：每 GHz 秒$0.0000100

**免费套餐**：200,000 GB 秒

**每月计算**：30 M x 0.2 秒 x 200 MHz / 1000 GHz = 1,200,000 GHz 秒

**每月 CPU 费用**：1,000,000 x $0.0000100 = $10

**每月总费用**= $11.2 + $0.875 + $10 = $22.075

由于单位价格略高于 AWS 和 Azure，运行相同函数的总月费用在 GCP 中超过$22，而在 AWS 和 Azure 中约为$11。此外，从函数到外部世界的任何出站网络在潜在的额外成本方面都是至关重要的。因此，在选择无服务器云平台之前，应深入分析定价方法和单位价格。

在下面的练习中，我们的第一个无服务器函数将部署到 GCF，并将被定时触发器调用，以显示平台的运行视图。

#### 注意

为了完成这个练习，您需要拥有一个活跃的 Google 账户。您可以在[`console.cloud.google.com/start`](https://console.cloud.google.com/start)上创建一个账户。

### 练习 6：在 GCF 中创建一个定时函数

在这个练习中，我们的目标是在 Google Cloud Platform 中创建一个定时函数，并使用云调度器服务来检查其调用。

要成功完成这个练习，我们需要确保执行以下步骤：

1.  点击左侧菜单中的**云函数**，它可以在 Google Cloud Platform 主页的**计算**组中找到，如下面的屏幕截图所示：![图 2.28：Google Cloud Platform 主页](img/C12607_02_28.jpg)

###### 图 2.28：Google Cloud Platform 主页

1.  点击**Cloud Functions**页面上的**创建函数**，如下面的屏幕截图所示：![图 2.29：云函数页面](img/C12607_02_29.jpg)

###### 图 2.29：云函数页面

1.  在函数创建表单中，将函数名称更改为`HelloWorld`，并选择 128 MB 的内存分配。确保选择**HTTP**作为触发方法，并选择**Go 1.11**作为运行时，如下面的屏幕截图所示：![图 2.30：函数创建表单](img/C12607_02_30.jpg)

###### 图 2.30：函数创建表单

1.  使用浏览器内联编辑器更改`function.go`，使其具有以下内容：

```
package p
import (
	"fmt"
	"net/http"
)
func HelloWorld(w http.ResponseWriter, r *http.Request) {
	fmt.Fprint(w, "Hello World from Google Cloud Functions!")
	return
}
```

此代码段创建一个带有静态消息打印到输出的`HelloWorld`函数。代码应插入到代码编辑器中的`function.go`中，如下截图所示：

![图 2.31：函数内联编辑器](img/C12607_02_31.jpg)

###### 图 2.31：函数内联编辑器

1.  复制“触发器”选择框下方表单中的 URL 以调用函数，如下截图所示：![图 2.32：函数触发 URL](img/C12607_02_32.jpg)

###### 图 2.32：函数触发 URL

1.  单击表单末尾的“创建”按钮。使用此配置，将打包并部署第 4 步的代码到 Google Cloud Platform。此外，将为函数分配一个触发器 URL，以便从外部访问，如下截图所示：![图 2.33：函数创建](img/C12607_02_33.jpg)

###### 图 2.33：函数创建

等待几分钟，直到函数列表中的`HelloWorld`函数旁边有一个绿色的勾号图标，如下截图所示：

![图 2.34：功能部署](img/C12607_02_34.jpg)

###### 图 2.34：功能部署

1.  在浏览器中打开您在第 5 步中复制的 URL，如下截图所示：![图 2.35：函数响应](img/C12607_02_35.jpg)

###### 图 2.35：函数响应

响应显示函数已成功部署并按预期运行。

1.  在左侧菜单中单击“TOOLS”下的“Cloud Scheduler”，如下截图所示：![图 2.36：Google Cloud 工具菜单](img/C12607_02_36.jpg)

###### 图 2.36：Google Cloud 工具菜单

1.  在“Cloud Scheduler”页面上单击“创建作业”，如下截图所示：![图 2.37：Cloud Scheduler 页面](img/C12607_02_37.jpg)

###### 图 2.37：Cloud Scheduler 页面

1.  如果您在 Google Cloud 项目中首次使用 Cloud Scheduler，请选择一个区域，然后单击“下一步”，如下截图所示：![图 2.38：Cloud Scheduler – 区域选择](img/C12607_02_38.jpg)

###### 图 2.38：Cloud Scheduler – 区域选择

如果看到以下通知，请等待几分钟：

**我们正在初始化您选择的区域中的 Cloud Scheduler。这通常需要大约一分钟**。

1.  将作业名称设置为`HelloWorldEveryMinute`，频率设置为`* * * * *`，这意味着作业将每分钟触发一次。选择 HTTP 作为目标，并将在步骤 5 中复制的 URL 粘贴到 URL 框中，如下面的屏幕截图所示：![图 2.39：调度程序作业创建](img/C12607_02_39.jpg)

###### 图 2.39：调度程序作业创建

1.  您将被重定向到**Cloud Scheduler**列表，如下面的屏幕截图所示：![图 2.40：云调度程序页面](img/C12607_02_40.jpg)

###### 图 2.40：云调度程序页面

等待几分钟，然后单击**刷新**按钮。列表将显示`HelloWorldEveryMinute`的**最后运行**时间戳及其结果，如下面的屏幕截图所示：

![图 2.41：带有运行信息的云调度程序页面](img/C12607_02_41.jpg)

###### 图 2.41：带有运行信息的云调度程序页面

这表明云调度程序在`2019 年 8 月 13 日下午 3:44:00`触发了我们的函数，并且结果是成功的。

1.  从第 7 步返回到函数列表，然后单击`HelloWorld`函数的**...**，然后单击**日志**，如下面的屏幕截图所示：![图 2.42：函数的设置菜单](img/C12607_02_42.jpg)

###### 图 2.42：函数的设置菜单

您将被重定向到函数的日志，您将看到，每分钟，`函数执行开始`和相应的成功日志被列出，如下面的屏幕截图所示：

![图 2.43：函数日志](img/C12607_02_43.jpg)

###### 图 2.43：函数日志

正如您所看到的，云调度程序正在按计划调用函数，并且函数正在成功运行。

1.  从第 13 步返回到云调度程序页面，选择`HelloWorldEveryMinute`，在菜单上单击**删除**，然后在弹出窗口中确认，如下面的屏幕截图所示：![图 2.44：云调度程序-作业删除](img/C12607_02_44.jpg)

###### 图 2.44：云调度程序-作业删除

1.  从第 7 步返回到**Cloud Functions**页面，选择`HelloWorld`，在菜单上单击**删除**，然后在弹出窗口中确认，如下面的屏幕截图所示：![图 2.45：云函数-函数删除](img/C12607_02_45.jpg)

###### 图 2.45：云函数-函数删除

在这个练习中，我们创建了一个`Hello World`功能并将其部署到 GCF。此外，还创建了一个云调度程序作业，以特定的间隔触发该功能，比如每分钟一次。现在，该功能已连接到另一个云服务，以便该功能可以触发该服务。在选择云 FaaS 提供商之前，将功能与其他云服务集成并评估其集成能力是至关重要的。

在以下活动中，您将开发一个真实的每日站立提醒功能。您将连接一个您希望在特定站立会议时间调用的功能和功能触发服务。此外，这个提醒将发送一个特定的消息到一个基于云的协作工具，即*Slack*。

### 活动 2：Slack 每日站立会议提醒功能

这个活动的目的是在 Slack 中创建一个真实的站立会议提醒功能。这个提醒功能将在特定时间被调用，以提醒您团队中的每个人下一次站立会议。提醒将与 Slack 一起工作，因为它是一种受到全球许多组织采用的流行协作工具。

#### 注意

为了完成这个活动，您需要访问 Slack 的工作区。您可以在[`slack.com/create`](https://slack.com/create)免费使用现有的 Slack 工作区或创建一个新的。

完成后，您将部署每日站立提醒功能到 GCF，如下截图所示：

![图 2.46：每日提醒功能](img/C12607_02_46.jpg)

###### 图 2.46：每日提醒功能

此外，您还需要一个集成环境来在指定的会议时间调用该功能。站立会议通常在工作日的特定时间举行。因此，调度程序作业将被连接以根据您的会议时间触发您的功能，如下截图所示：

![图 2.47：每日提醒调度程序](img/C12607_02_47.jpg)

###### 图 2.47：每日提醒调度程序

最后，当调度程序调用该功能时，您将在 Slack 频道中收到提醒消息，如下截图所示：

![图 2.48：Slack 会议提醒消息](img/C12607_02_48.jpg)

###### 图 2.48：Slack 会议提醒消息

#### 注意

为了完成这个活动，您应该按照 Slack 设置步骤配置 Slack。

**Slack 设置**

执行以下步骤配置 Slack：

1.  在 Slack 工作区中，点击您的用户名，然后选择自定义 Slack。

1.  在打开的窗口中点击**配置应用**。

1.  点击**浏览应用目录**以从目录中添加新应用。

1.  从**应用目录**的搜索框中找到**传入 WebHooks**。

1.  点击**添加配置**以添加**传入 WebHooks**应用。

1.  填写传入 Webhook 的配置，包括您特定的频道名称和图标。

1.  打开您的 Slack 工作区和频道。您会看到一个集成消息。

#### 注意

在第 376 页可以找到 Slack 设置步骤的详细截图。

执行以下步骤完成此活动：

1.  在 GCF 中创建一个新函数，在调用时调用 Slack Webhook。

代码应该向 Slack Webhook URL 发送一个类似的 JSON 请求对象：`{"text": "Time for a stand-up meeting"}`。您可以使用 GCF 支持的任何语言来实现代码。代码片段如下：

```
package p
import (
    "bytes"
    "net/http"
)
func Reminder(http.ResponseWriter, *http.Request) {
    url := "https://hooks.slack.com/services/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"

    var jsonStr = []byte('{"text": "Time for a stand-up meeting!"}')
    req, err := http.NewRequest("POST", url, bytes.NewBuffer(jsonStr))

    client := &http.Client{}
    _, err = client.Do(req)
    if err != nil {
        panic(err)
    }
}
```

1.  在 GCP 中使用函数的触发 URL 创建一个调度程序作业，并根据您的站立会议时间指定调度。

在提醒消息的预定时间到达时，检查 Slack 频道。

1.  从云提供商中删除调度作业和函数。

#### 注意

此活动的解决方案可在第 376 页找到。

## 摘要

在本章中，我们描述了云技术产品的演变，包括云产品多年来的变化以及责任如何在组织之间分配，从 IaaS 和 PaaS 开始，最终到 FaaS。随后，介绍了评估无服务器云产品的标准。

编程语言支持、函数触发器和无服务器产品的成本结构被列出，以便我们可以比较各个云提供商，即 AWS Lambda、Azure Functions 和 GCF。此外，我们将无服务器函数部署到了所有三个云提供商。这展示了云函数如何与其他云服务集成，比如用于 REST API 操作的 AWS API Gateway。此外，我们部署了一个参数化函数到 Azure Functions，以展示我们如何处理来自用户或其他系统的输入。最后，我们部署了一个定时函数到 GCF，以展示与其他云服务的集成。在本章末尾，我们使用无服务器函数和云调度程序实现了一个真实的 Slack 提醒。

在下一章中，我们将介绍无服务器框架，并学习如何与它们一起工作。
